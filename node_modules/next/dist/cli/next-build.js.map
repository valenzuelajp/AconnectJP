{"version":3,"sources":["../../src/cli/next-build.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport { saveCpuProfile } from '../server/lib/cpu-profile'\nimport { existsSync } from 'fs'\nimport { italic } from '../lib/picocolors'\nimport build from '../build'\nimport { warn } from '../build/output/log'\nimport { printAndExit } from '../server/lib/utils'\nimport isError from '../lib/is-error'\nimport { getProjectDir } from '../lib/get-project-dir'\nimport { enableMemoryDebuggingMode } from '../lib/memory/startup'\nimport { disableMemoryDebuggingMode } from '../lib/memory/shutdown'\nimport { Bundler, parseBundlerArgs } from '../lib/bundler'\nimport {\n  resolveBuildPaths,\n  parseBuildPathsInput,\n} from '../lib/resolve-build-paths'\n\nexport type NextBuildOptions = {\n  experimentalAnalyze?: boolean\n  debug?: boolean\n  debugPrerender?: boolean\n  profile?: boolean\n  mangling: boolean\n  turbo?: boolean\n  turbopack?: boolean\n  webpack?: boolean\n  experimentalDebugMemoryUsage: boolean\n  experimentalAppOnly?: boolean\n  experimentalTurbo?: boolean\n  experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env'\n  experimentalUploadTrace?: string\n  experimentalNextConfigStripTypes?: boolean\n  debugBuildPaths?: string\n  experimentalCpuProf?: boolean\n}\n\nconst nextBuild = async (options: NextBuildOptions, directory?: string) => {\n  process.on('SIGTERM', () => {\n    saveCpuProfile()\n    process.exit(143)\n  })\n  process.on('SIGINT', () => {\n    saveCpuProfile()\n    process.exit(130)\n  })\n\n  const {\n    experimentalAnalyze,\n    debug,\n    debugPrerender,\n    experimentalDebugMemoryUsage,\n    profile,\n    mangling,\n    experimentalAppOnly,\n    experimentalBuildMode,\n    experimentalUploadTrace,\n    debugBuildPaths,\n  } = options\n\n  let traceUploadUrl: string | undefined\n  if (experimentalUploadTrace && !process.env.NEXT_TRACE_UPLOAD_DISABLED) {\n    traceUploadUrl = experimentalUploadTrace\n  }\n\n  const bundler = parseBundlerArgs(options)\n\n  if (experimentalAnalyze && bundler !== Bundler.Turbopack) {\n    printAndExit(\n      '--experimental-analyze is only compatible with the Turbopack bundler.'\n    )\n  }\n\n  if (!mangling) {\n    warn(\n      `Mangling is disabled. ${italic('Note: This may affect performance and should only be used for debugging purposes.')}`\n    )\n  }\n\n  if (profile) {\n    warn(\n      `Profiling is enabled. ${italic('Note: This may affect performance.')}`\n    )\n  }\n\n  if (debugPrerender) {\n    warn(\n      `Prerendering is running in debug mode. ${italic(\n        'Note: This may affect performance and should not be used for production.'\n      )}`\n    )\n  }\n\n  if (experimentalDebugMemoryUsage) {\n    process.env.EXPERIMENTAL_DEBUG_MEMORY_USAGE = '1'\n    enableMemoryDebuggingMode()\n  }\n\n  const dir = getProjectDir(directory)\n\n  if (!existsSync(dir)) {\n    printAndExit(`> No such directory exists as the project root: ${dir}`)\n  }\n\n  // Resolve selective build paths\n  let resolvedBuildPaths: { app: string[]; pages: string[] } | undefined\n\n  if (debugBuildPaths) {\n    try {\n      const patterns = parseBuildPathsInput(debugBuildPaths)\n\n      if (patterns.length > 0) {\n        const resolved = await resolveBuildPaths(patterns, dir)\n        resolvedBuildPaths = {\n          app: resolved.appPaths,\n          pages: resolved.pagePaths,\n        }\n      }\n    } catch (err) {\n      printAndExit(\n        `Failed to resolve build paths: ${isError(err) ? err.message : String(err)}`\n      )\n    }\n  }\n\n  return build(\n    dir,\n    experimentalAnalyze,\n    profile,\n    debug || Boolean(process.env.NEXT_DEBUG_BUILD),\n    debugPrerender,\n    !mangling,\n    experimentalAppOnly,\n    bundler,\n    experimentalBuildMode,\n    traceUploadUrl,\n    resolvedBuildPaths\n  )\n    .catch((err) => {\n      if (experimentalDebugMemoryUsage) {\n        disableMemoryDebuggingMode()\n      }\n      console.error('')\n      if (\n        isError(err) &&\n        (err.code === 'INVALID_RESOLVE_ALIAS' ||\n          err.code === 'WEBPACK_ERRORS' ||\n          err.code === 'BUILD_OPTIMIZATION_FAILED' ||\n          err.code === 'NEXT_EXPORT_ERROR' ||\n          err.code === 'NEXT_STATIC_GEN_BAILOUT' ||\n          err.code === 'EDGE_RUNTIME_UNSUPPORTED_API')\n      ) {\n        printAndExit(`> ${err.message}`)\n      } else {\n        console.error('> Build error occurred')\n        printAndExit(err)\n      }\n    })\n    .finally(() => {\n      if (experimentalDebugMemoryUsage) {\n        disableMemoryDebuggingMode()\n      }\n    })\n}\n\nexport { nextBuild, saveCpuProfile }\n"],"names":["nextBuild","saveCpuProfile","options","directory","process","on","exit","experimentalAnalyze","debug","debugPrerender","experimentalDebugMemoryUsage","profile","mangling","experimentalAppOnly","experimentalBuildMode","experimentalUploadTrace","debugBuildPaths","traceUploadUrl","env","NEXT_TRACE_UPLOAD_DISABLED","bundler","parseBundlerArgs","Bundler","Turbopack","printAndExit","warn","italic","EXPERIMENTAL_DEBUG_MEMORY_USAGE","enableMemoryDebuggingMode","dir","getProjectDir","existsSync","resolvedBuildPaths","patterns","parseBuildPathsInput","length","resolved","resolveBuildPaths","app","appPaths","pages","pagePaths","err","isError","message","String","build","Boolean","NEXT_DEBUG_BUILD","catch","disableMemoryDebuggingMode","console","error","code","finally"],"mappings":"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","ignoreList":[0]}