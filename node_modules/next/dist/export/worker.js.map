{"version":3,"sources":["../../src/export/worker.ts"],"sourcesContent":["import type {\n  ExportPagesInput,\n  ExportPageInput,\n  ExportPageResult,\n  ExportRouteResult,\n  WorkerRenderOpts,\n  ExportPagesResult,\n  ExportPathEntry,\n} from './types'\nimport type { AppPageModule } from '../server/route-modules/app-page/module'\nimport type { PagesModule } from '../server/route-modules/pages/module.compiled'\n\nimport '../server/node-environment'\n\nprocess.env.NEXT_IS_EXPORT_WORKER = 'true'\n\nimport { extname, join, dirname, sep } from 'path'\nimport fs from 'fs/promises'\nimport { loadComponents } from '../server/load-components'\nimport { isDynamicRoute } from '../shared/lib/router/utils/is-dynamic'\nimport { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\nimport { normalizeLocalePath } from '../shared/lib/i18n/normalize-locale-path'\nimport { trace } from '../trace'\nimport { setHttpClientAndAgentOptions } from '../server/setup-http-agent-env'\nimport { addRequestMeta } from '../server/request-meta'\nimport { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\nimport { removeTrailingSlash } from '../shared/lib/router/utils/remove-trailing-slash'\n\nimport { createRequestResponseMocks } from '../server/lib/mock-request'\nimport { isAppRouteRoute } from '../lib/is-app-route-route'\nimport { hasNextSupport } from '../server/ci-info'\nimport { exportAppRoute } from './routes/app-route'\nimport { exportAppPage } from './routes/app-page'\nimport { exportPagesPage } from './routes/pages'\nimport { getParams } from './helpers/get-params'\nimport { createIncrementalCache } from './helpers/create-incremental-cache'\nimport { isPostpone } from '../server/lib/router-utils/is-postpone'\nimport { isDynamicUsageError } from './helpers/is-dynamic-usage-error'\nimport { isBailoutToCSRError } from '../shared/lib/lazy-dynamic/bailout-to-csr'\nimport {\n  turborepoTraceAccess,\n  TurborepoAccessTraceResult,\n} from '../build/turborepo-access-trace'\nimport type { Params } from '../server/request/params'\nimport {\n  createOpaqueFallbackRouteParams,\n  type OpaqueFallbackRouteParams,\n} from '../server/request/fallback-params'\nimport { needsExperimentalReact } from '../lib/needs-experimental-react'\nimport type { AppRouteRouteModule } from '../server/route-modules/app-route/module.compiled'\nimport { isStaticGenBailoutError } from '../client/components/static-generation-bailout'\nimport type { PagesRenderContext, PagesSharedContext } from '../server/render'\nimport type { AppSharedContext } from '../server/app-render/app-render'\nimport { MultiFileWriter } from '../lib/multi-file-writer'\nimport { createRenderResumeDataCache } from '../server/resume-data-cache/resume-data-cache'\nimport { installGlobalBehaviors } from '../server/node-environment-extensions/global-behaviors'\n;(globalThis as any).__NEXT_DATA__ = {\n  nextExport: true,\n}\n\nclass TimeoutError extends Error {\n  code = 'NEXT_EXPORT_TIMEOUT_ERROR'\n}\n\nclass ExportPageError extends Error {\n  code = 'NEXT_EXPORT_PAGE_ERROR'\n}\n\nasync function exportPageImpl(\n  input: ExportPageInput,\n  fileWriter: MultiFileWriter\n): Promise<ExportRouteResult | undefined> {\n  const {\n    exportPath,\n    distDir,\n    pagesDataDir,\n    buildExport = false,\n    subFolders = false,\n    optimizeCss,\n    disableOptimizedLoading,\n    debugOutput = false,\n    enableExperimentalReact,\n    trailingSlash,\n    sriEnabled,\n    renderOpts: commonRenderOpts,\n    outDir: commonOutDir,\n    buildId,\n    deploymentId,\n    renderResumeDataCache,\n  } = input\n\n  if (enableExperimentalReact) {\n    process.env.__NEXT_EXPERIMENTAL_REACT = 'true'\n  }\n\n  const {\n    path,\n    page,\n\n    // The parameters that are currently unknown.\n    _fallbackRouteParams = [],\n\n    // Check if this is an `app/` page.\n    _isAppDir: isAppDir = false,\n\n    // Check if this should error when dynamic usage is detected.\n    _isDynamicError: isDynamicError = false,\n\n    // If this page supports partial prerendering, then we need to pass that to\n    // the renderOpts.\n    _isRoutePPREnabled: isRoutePPREnabled,\n\n    // Configure the rendering of the page to allow that an empty static shell\n    // is generated while rendering using PPR and Cache Components.\n    _allowEmptyStaticShell: allowEmptyStaticShell = false,\n\n    // Pull the original query out.\n    query: originalQuery = {},\n  } = exportPath\n\n  const fallbackRouteParams: OpaqueFallbackRouteParams | null =\n    createOpaqueFallbackRouteParams(_fallbackRouteParams)\n\n  let query = { ...originalQuery }\n  const pathname = normalizeAppPath(page)\n  const isDynamic = isDynamicRoute(page)\n  const outDir = isAppDir ? join(distDir, 'server/app') : commonOutDir\n\n  const filePath = normalizePagePath(path)\n\n  let updatedPath = exportPath._ssgPath || path\n  let locale = exportPath._locale || commonRenderOpts.locale\n\n  if (commonRenderOpts.locale) {\n    const localePathResult = normalizeLocalePath(path, commonRenderOpts.locales)\n\n    if (localePathResult.detectedLocale) {\n      updatedPath = localePathResult.pathname\n      locale = localePathResult.detectedLocale\n    }\n  }\n\n  // We need to show a warning if they try to provide query values\n  // for an auto-exported page since they won't be available\n  const hasOrigQueryValues = Object.keys(originalQuery).length > 0\n\n  // Check if the page is a specified dynamic route\n  const { pathname: nonLocalizedPath } = normalizeLocalePath(\n    path,\n    commonRenderOpts.locales\n  )\n\n  let params: Params | undefined\n\n  if (isDynamic && page !== nonLocalizedPath) {\n    const normalizedPage = isAppDir ? normalizeAppPath(page) : page\n\n    params = getParams(normalizedPage, updatedPath)\n  }\n\n  const { req, res } = createRequestResponseMocks({ url: updatedPath })\n\n  // If this is a status code page, then set the response code.\n  for (const statusCode of [404, 500]) {\n    if (\n      [\n        `/${statusCode}`,\n        `/${statusCode}.html`,\n        `/${statusCode}/index.html`,\n      ].some((p) => p === updatedPath || `/${locale}${p}` === updatedPath)\n    ) {\n      res.statusCode = statusCode\n    }\n  }\n\n  // Ensure that the URL has a trailing slash if it's configured.\n  if (trailingSlash && !req.url?.endsWith('/')) {\n    req.url += '/'\n  }\n\n  // Set the resolved pathname without trailing slash as request metadata.\n  addRequestMeta(req, 'resolvedPathname', removeTrailingSlash(updatedPath))\n\n  if (\n    locale &&\n    buildExport &&\n    commonRenderOpts.domainLocales &&\n    commonRenderOpts.domainLocales.some(\n      (dl) => dl.defaultLocale === locale || dl.locales?.includes(locale || '')\n    )\n  ) {\n    addRequestMeta(req, 'isLocaleDomain', true)\n  }\n\n  const getHtmlFilename = (p: string) =>\n    subFolders ? `${p}${sep}index.html` : `${p}.html`\n\n  let htmlFilename = getHtmlFilename(filePath)\n\n  // dynamic routes can provide invalid extensions e.g. /blog/[...slug] returns an\n  // extension of `.slug]`\n  const pageExt = isDynamic || isAppDir ? '' : extname(page)\n  const pathExt = isDynamic || isAppDir ? '' : extname(path)\n\n  // force output 404.html for backwards compat\n  if (path === '/404.html') {\n    htmlFilename = path\n  }\n  // Make sure page isn't a folder with a dot in the name e.g. `v1.2`\n  else if (pageExt !== pathExt && pathExt !== '') {\n    const isBuiltinPaths = ['/500', '/404'].some(\n      (p) => p === path || p === path + '.html'\n    )\n    // If the ssg path has .html extension, and it's not builtin paths, use it directly\n    // Otherwise, use that as the filename instead\n    const isHtmlExtPath = !isBuiltinPaths && path.endsWith('.html')\n    htmlFilename = isHtmlExtPath ? getHtmlFilename(path) : path\n  } else if (path === '/') {\n    // If the path is the root, just use index.html\n    htmlFilename = 'index.html'\n  }\n\n  const baseDir = join(outDir, dirname(htmlFilename))\n  let htmlFilepath = join(outDir, htmlFilename)\n\n  await fs.mkdir(baseDir, { recursive: true })\n\n  const components = await loadComponents({\n    distDir,\n    page,\n    isAppPath: isAppDir,\n    isDev: false,\n    sriEnabled,\n    needsManifestsForLegacyReasons: true,\n  })\n\n  // Handle App Routes.\n  if (isAppDir && isAppRouteRoute(page)) {\n    return exportAppRoute(\n      req,\n      res,\n      params,\n      page,\n      components.routeModule as AppRouteRouteModule,\n      commonRenderOpts.incrementalCache,\n      commonRenderOpts.cacheLifeProfiles,\n      htmlFilepath,\n      fileWriter,\n      commonRenderOpts.cacheComponents,\n      commonRenderOpts.experimental,\n      buildId\n    )\n  }\n\n  const renderOpts: WorkerRenderOpts = {\n    ...components,\n    ...commonRenderOpts,\n    params,\n    optimizeCss,\n    disableOptimizedLoading,\n    locale,\n    supportsDynamicResponse: false,\n    // During the export phase in next build, we always enable the streaming metadata since if there's\n    // any dynamic access in metadata we can determine it in the build phase.\n    // If it's static, then it won't affect anything.\n    // If it's dynamic, then it can be handled when request hits the route.\n    serveStreamingMetadata: true,\n    allowEmptyStaticShell,\n    experimental: {\n      ...commonRenderOpts.experimental,\n      isRoutePPREnabled,\n    },\n    renderResumeDataCache,\n  }\n\n  // Handle App Pages\n  if (isAppDir) {\n    const sharedContext: AppSharedContext = { buildId, deploymentId }\n\n    return exportAppPage(\n      req,\n      res,\n      page,\n      path,\n      pathname,\n      query,\n      fallbackRouteParams,\n      renderOpts as WorkerRenderOpts<AppPageModule>,\n      htmlFilepath,\n      debugOutput,\n      isDynamicError,\n      fileWriter,\n      sharedContext\n    )\n  } else {\n    const sharedContext: PagesSharedContext = {\n      buildId,\n      deploymentId,\n      customServer: undefined,\n    }\n\n    const renderContext: PagesRenderContext = {\n      isFallback: exportPath._pagesFallback ?? false,\n      isDraftMode: false,\n      developmentNotFoundSourcePage: undefined,\n    }\n\n    return exportPagesPage(\n      req,\n      res,\n      path,\n      page,\n      query,\n      params,\n      htmlFilepath,\n      htmlFilename,\n      pagesDataDir,\n      buildExport,\n      isDynamic,\n      sharedContext,\n      renderContext,\n      hasOrigQueryValues,\n      renderOpts as WorkerRenderOpts<PagesModule>,\n      components,\n      fileWriter\n    )\n  }\n}\n\nexport async function exportPages(\n  input: ExportPagesInput\n): Promise<ExportPagesResult> {\n  const {\n    exportPaths,\n    dir,\n    distDir,\n    outDir,\n    cacheHandler,\n    cacheMaxMemorySize,\n    fetchCacheKeyPrefix,\n    pagesDataDir,\n    renderOpts,\n    nextConfig,\n    options,\n    renderResumeDataCachesByPage = {},\n    deploymentId,\n  } = input\n\n  // Set the global asset suffix for Turbopack compiled code to use during prerendering\n  ;(globalThis as any).NEXT_CLIENT_ASSET_SUFFIX = deploymentId\n    ? `?dpl=${deploymentId}`\n    : ''\n\n  installGlobalBehaviors(nextConfig)\n\n  if (nextConfig.enablePrerenderSourceMaps) {\n    try {\n      // Same as `next dev`\n      // Limiting the stack trace to a useful amount of frames is handled by ignore-listing.\n      // TODO: How high can we go without severely impacting CPU/memory?\n      Error.stackTraceLimit = 50\n    } catch {}\n  }\n\n  // If the fetch cache was enabled, we need to create an incremental\n  // cache instance for this page.\n  const incrementalCache = await createIncrementalCache({\n    cacheHandler,\n    cacheMaxMemorySize,\n    fetchCacheKeyPrefix,\n    distDir,\n    dir,\n    // skip writing to disk in minimal mode for now, pending some\n    // changes to better support it\n    flushToDisk: !hasNextSupport,\n    cacheHandlers: nextConfig.cacheHandlers,\n  })\n\n  renderOpts.incrementalCache = incrementalCache\n\n  const maxConcurrency =\n    nextConfig.experimental.staticGenerationMaxConcurrency ?? 8\n  const results: ExportPagesResult = []\n\n  const exportPageWithRetry = async (\n    exportPath: ExportPathEntry,\n    maxAttempts: number\n  ) => {\n    const { page, path } = exportPath\n    const pageKey = page !== path ? `${page}: ${path}` : path\n    let attempt = 0\n    let result\n\n    const hasDebuggerAttached =\n      // Also tests for `inspect-brk`\n      process.env.NODE_OPTIONS?.includes('--inspect')\n\n    const renderResumeDataCache = renderResumeDataCachesByPage[pageKey]\n      ? createRenderResumeDataCache(\n          renderResumeDataCachesByPage[pageKey],\n          renderOpts.experimental.maxPostponedStateSizeBytes\n        )\n      : undefined\n\n    while (attempt < maxAttempts) {\n      try {\n        result = await Promise.race<ExportPageResult | undefined>([\n          exportPage({\n            exportPath,\n            distDir,\n            outDir,\n            pagesDataDir,\n            renderOpts,\n            trailingSlash: nextConfig.trailingSlash,\n            subFolders: nextConfig.trailingSlash && !options.buildExport,\n            buildExport: options.buildExport,\n            optimizeCss: nextConfig.experimental.optimizeCss,\n            disableOptimizedLoading:\n              nextConfig.experimental.disableOptimizedLoading,\n            parentSpanId: input.parentSpanId,\n            httpAgentOptions: nextConfig.httpAgentOptions,\n            debugOutput: options.debugOutput,\n            enableExperimentalReact: needsExperimentalReact(nextConfig),\n            sriEnabled: Boolean(nextConfig.experimental.sri?.algorithm),\n            buildId: input.buildId,\n            deploymentId: input.deploymentId,\n            renderResumeDataCache,\n          }),\n          hasDebuggerAttached\n            ? // With a debugger attached, exporting can take infinitely if we paused script execution.\n              new Promise(() => {})\n            : // If exporting the page takes longer than the timeout, reject the promise.\n              new Promise((_, reject) => {\n                setTimeout(() => {\n                  reject(new TimeoutError())\n                }, nextConfig.staticPageGenerationTimeout * 1000)\n              }),\n        ])\n\n        // If there was an error in the export, throw it immediately. In the catch block, we might retry the export,\n        // or immediately fail the build, depending on user configuration. We might also continue on and attempt other pages.\n        if (result && 'error' in result) {\n          throw new ExportPageError()\n        }\n\n        // If the export succeeds, break out of the retry loop\n        break\n      } catch (err) {\n        // The only error that should be caught here is an ExportError, as `exportPage` doesn't throw and instead returns an object with an `error` property.\n        // This is an overly cautious check to ensure that we don't accidentally catch an unexpected error.\n        if (!(err instanceof ExportPageError || err instanceof TimeoutError)) {\n          throw err\n        }\n\n        if (err instanceof TimeoutError) {\n          // If the export times out, we will restart the worker up to 3 times.\n          maxAttempts = 3\n        }\n\n        // We've reached the maximum number of attempts\n        if (attempt >= maxAttempts - 1) {\n          // Log a message if we've reached the maximum number of attempts.\n          // We only care to do this if maxAttempts was configured.\n          if (maxAttempts > 1) {\n            console.info(\n              `Failed to build ${pageKey} after ${maxAttempts} attempts.`\n            )\n          }\n          // If prerenderEarlyExit is enabled, we'll exit the build immediately.\n          if (nextConfig.experimental.prerenderEarlyExit) {\n            console.error(\n              `Export encountered an error on ${pageKey}, exiting the build.`\n            )\n            process.exit(1)\n          } else {\n            // Otherwise, this is a no-op. The build will continue, and a summary of failed pages will be displayed at the end.\n          }\n        } else {\n          // Otherwise, we have more attempts to make. Wait before retrying\n          if (err instanceof TimeoutError) {\n            console.info(\n              `Failed to build ${pageKey} (attempt ${attempt + 1} of ${maxAttempts}) because it took more than ${nextConfig.staticPageGenerationTimeout} seconds. Retrying again shortly.`\n            )\n          } else {\n            console.info(\n              `Failed to build ${pageKey} (attempt ${attempt + 1} of ${maxAttempts}). Retrying again shortly.`\n            )\n          }\n\n          // Exponential backoff with random jitter to avoid thundering herd on retries\n          const baseDelay = 500 // 500ms\n          const maxDelay = 2000 // 2 seconds\n          const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay)\n          const jitter = Math.random() * 0.3 * delay // Add up to 30% random jitter\n          await new Promise((r) => setTimeout(r, delay + jitter))\n        }\n      }\n\n      attempt++\n    }\n\n    return { result, path, page, pageKey }\n  }\n\n  for (let i = 0; i < exportPaths.length; i += maxConcurrency) {\n    const subset = exportPaths.slice(i, i + maxConcurrency)\n\n    const subsetResults = await Promise.all(\n      subset.map((exportPath) =>\n        exportPageWithRetry(\n          exportPath,\n          nextConfig.experimental.staticGenerationRetryCount ?? 1\n        )\n      )\n    )\n\n    results.push(...subsetResults)\n  }\n\n  return results\n}\n\nasync function exportPage(\n  input: ExportPageInput\n): Promise<ExportPageResult | undefined> {\n  trace('export-page', input.parentSpanId).setAttribute(\n    'path',\n    input.exportPath.path\n  )\n\n  // Configure the http agent.\n  setHttpClientAndAgentOptions({\n    httpAgentOptions: input.httpAgentOptions,\n  })\n\n  const fileWriter = new MultiFileWriter({\n    writeFile: (filePath, data) => fs.writeFile(filePath, data),\n    mkdir: (dir) => fs.mkdir(dir, { recursive: true }),\n  })\n\n  const exportPageSpan = trace('export-page-worker', input.parentSpanId)\n\n  const start = Date.now()\n\n  const turborepoAccessTraceResult = new TurborepoAccessTraceResult()\n\n  // Export the page.\n  let result: ExportRouteResult | undefined\n  try {\n    result = await exportPageSpan.traceAsyncFn(() =>\n      turborepoTraceAccess(\n        () => exportPageImpl(input, fileWriter),\n        turborepoAccessTraceResult\n      )\n    )\n\n    // Wait for all the files to flush to disk.\n    await fileWriter.wait()\n\n    // If there was no result, then we can exit early.\n    if (!result) return\n\n    // If there was an error, then we can exit early.\n    if ('error' in result) {\n      return { error: result.error, duration: Date.now() - start }\n    }\n  } catch (err) {\n    console.error(\n      `Error occurred prerendering page \"${input.exportPath.path}\". Read more: https://nextjs.org/docs/messages/prerender-error`\n    )\n\n    // bailoutToCSRError errors should not leak to the user as they are not actionable; they're\n    // a framework signal\n    if (!isBailoutToCSRError(err)) {\n      // A static generation bailout error is a framework signal to fail static generation but\n      // and will encode a reason in the error message. If there is a message, we'll print it.\n      // Otherwise there's nothing to show as we don't want to leak an error internal error stack to the user.\n      // TODO: Always log the full error. ignore-listing will take care of hiding internal stacks.\n      if (isStaticGenBailoutError(err)) {\n        if (err.message) {\n          console.error(`Error: ${err.message}`)\n        }\n      } else {\n        console.error(err)\n      }\n    }\n\n    return { error: true, duration: Date.now() - start }\n  }\n\n  // Notify the parent process that we processed a page (used by the progress activity indicator)\n  process.send?.([3, { type: 'activity' }])\n\n  // Otherwise we can return the result.\n  return {\n    ...result,\n    duration: Date.now() - start,\n    turborepoAccessTraceResult: turborepoAccessTraceResult.serialize(),\n  }\n}\n\nprocess.on('unhandledRejection', (err: unknown) => {\n  // if it's a postpone error, it'll be handled later\n  // when the postponed promise is actually awaited.\n  if (isPostpone(err)) {\n    return\n  }\n\n  // we don't want to log these errors\n  if (isDynamicUsageError(err)) {\n    return\n  }\n\n  console.error(err)\n})\n\nprocess.on('rejectionHandled', () => {\n  // It is ok to await a Promise late in Next.js as it allows for better\n  // prefetching patterns to avoid waterfalls. We ignore logging these.\n  // We should've already errored in anyway unhandledRejection.\n})\n\nconst FATAL_UNHANDLED_NEXT_API_EXIT_CODE = 78\n\nprocess.on('uncaughtException', (err) => {\n  if (isDynamicUsageError(err)) {\n    console.error(\n      'A Next.js API that uses exceptions to signal framework behavior was uncaught. This suggests improper usage of a Next.js API. The original error is printed below and the build will now exit.'\n    )\n    console.error(err)\n    process.exit(FATAL_UNHANDLED_NEXT_API_EXIT_CODE)\n  } else {\n    console.error(err)\n  }\n})\n"],"names":["exportPages","process","env","NEXT_IS_EXPORT_WORKER","globalThis","__NEXT_DATA__","nextExport","TimeoutError","Error","code","ExportPageError","exportPageImpl","input","fileWriter","req","exportPath","distDir","pagesDataDir","buildExport","subFolders","optimizeCss","disableOptimizedLoading","debugOutput","enableExperimentalReact","trailingSlash","sriEnabled","renderOpts","commonRenderOpts","outDir","commonOutDir","buildId","deploymentId","renderResumeDataCache","__NEXT_EXPERIMENTAL_REACT","path","page","_fallbackRouteParams","_isAppDir","isAppDir","_isDynamicError","isDynamicError","_isRoutePPREnabled","isRoutePPREnabled","_allowEmptyStaticShell","allowEmptyStaticShell","query","originalQuery","fallbackRouteParams","createOpaqueFallbackRouteParams","pathname","normalizeAppPath","isDynamic","isDynamicRoute","join","filePath","normalizePagePath","updatedPath","_ssgPath","locale","_locale","localePathResult","normalizeLocalePath","locales","detectedLocale","hasOrigQueryValues","Object","keys","length","nonLocalizedPath","params","normalizedPage","getParams","res","createRequestResponseMocks","url","statusCode","some","p","endsWith","addRequestMeta","removeTrailingSlash","domainLocales","dl","defaultLocale","includes","getHtmlFilename","sep","htmlFilename","pageExt","extname","pathExt","isBuiltinPaths","isHtmlExtPath","baseDir","dirname","htmlFilepath","fs","mkdir","recursive","components","loadComponents","isAppPath","isDev","needsManifestsForLegacyReasons","isAppRouteRoute","exportAppRoute","routeModule","incrementalCache","cacheLifeProfiles","cacheComponents","experimental","supportsDynamicResponse","serveStreamingMetadata","sharedContext","exportAppPage","customServer","undefined","renderContext","isFallback","_pagesFallback","isDraftMode","developmentNotFoundSourcePage","exportPagesPage","exportPaths","dir","cacheHandler","cacheMaxMemorySize","fetchCacheKeyPrefix","nextConfig","options","renderResumeDataCachesByPage","NEXT_CLIENT_ASSET_SUFFIX","installGlobalBehaviors","enablePrerenderSourceMaps","stackTraceLimit","createIncrementalCache","flushToDisk","hasNextSupport","cacheHandlers","maxConcurrency","staticGenerationMaxConcurrency","results","exportPageWithRetry","maxAttempts","pageKey","attempt","result","hasDebuggerAttached","NODE_OPTIONS","createRenderResumeDataCache","maxPostponedStateSizeBytes","Promise","race","exportPage","parentSpanId","httpAgentOptions","needsExperimentalReact","Boolean","sri","algorithm","_","reject","setTimeout","staticPageGenerationTimeout","err","console","info","prerenderEarlyExit","error","exit","baseDelay","maxDelay","delay","Math","min","pow","jitter","random","r","i","subset","slice","subsetResults","all","map","staticGenerationRetryCount","push","trace","setAttribute","setHttpClientAndAgentOptions","MultiFileWriter","writeFile","data","exportPageSpan","start","Date","now","turborepoAccessTraceResult","TurborepoAccessTraceResult","traceAsyncFn","turborepoTraceAccess","wait","duration","isBailoutToCSRError","isStaticGenBailoutError","message","send","type","serialize","on","isPostpone","isDynamicUsageError","FATAL_UNHANDLED_NEXT_API_EXIT_CODE"],"mappings":"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","ignoreList":[0]}