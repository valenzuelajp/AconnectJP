{"version":3,"sources":["../../../src/build/templates/middleware.ts"],"sourcesContent":["import type { AdapterOptions, EdgeHandler } from '../../server/web/adapter'\nimport '../adapter/setup-node-env.external'\nimport '../../server/web/globals'\n\nimport { adapter } from '../../server/web/adapter'\n\n// Import the userland code.\nimport * as _mod from 'VAR_USERLAND'\nimport { edgeInstrumentationOnRequestError } from '../../server/web/globals'\nimport { isNextRouterError } from '../../client/components/is-next-router-error'\nimport { toNodeOutgoingHttpHeaders } from '../../server/web/utils'\nimport type { RequestMeta } from '../../server/request-meta'\n\nconst mod = { ..._mod }\n\nconst page: string = 'VAR_DEFINITION_PAGE'\nconst isProxy = page === '/proxy' || page === '/src/proxy'\nconst handlerUserland = (isProxy ? mod.proxy : mod.middleware) || mod.default\n\nclass ProxyMissingExportError extends Error {\n  constructor(message: string) {\n    super(message)\n    // Stack isn't useful here, remove it considering it spams logs during development.\n    this.stack = ''\n  }\n}\n\n// TODO: This spams logs during development. Find a better way to handle this.\n// Removing this will spam \"fn is not a function\" logs which is worse.\nif (typeof handlerUserland !== 'function') {\n  throw new ProxyMissingExportError(\n    `The ${isProxy ? 'Proxy' : 'Middleware'} file \"${page}\" must export a function named \\`${isProxy ? 'proxy' : 'middleware'}\\` or a default function.`\n  )\n}\n\n// Proxy will only sent out the FetchEvent to next server,\n// so load instrumentation module here and track the error inside proxy module.\nfunction errorHandledHandler(fn: AdapterOptions['handler']) {\n  return async (...args: Parameters<AdapterOptions['handler']>) => {\n    try {\n      return await fn(...args)\n    } catch (err) {\n      // In development, error the navigation API usage in runtime,\n      // since it's not allowed to be used in proxy as it's outside of react component tree.\n      if (process.env.NODE_ENV !== 'production') {\n        if (isNextRouterError(err)) {\n          err.message = `Next.js navigation API is not allowed to be used in ${isProxy ? 'Proxy' : 'Middleware'}.`\n          throw err\n        }\n      }\n      const req = args[0]\n      const url = new URL(req.url)\n      const resource = url.pathname + url.search\n      await edgeInstrumentationOnRequestError(\n        err,\n        {\n          path: resource,\n          method: req.method,\n          headers: Object.fromEntries(req.headers.entries()),\n        },\n        {\n          routerKind: 'Pages Router',\n          routePath: '/proxy',\n          routeType: 'proxy',\n          revalidateReason: undefined,\n        }\n      )\n\n      throw err\n    }\n  }\n}\n\nconst internalHandler: EdgeHandler = (opts) => {\n  return adapter({\n    ...opts,\n    page,\n    handler: errorHandledHandler(handlerUserland),\n  })\n}\n\nexport async function handler(\n  request: Request,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n    signal?: AbortSignal\n    requestMeta?: RequestMeta\n  }\n): Promise<Response> {\n  const result = await internalHandler({\n    request: {\n      url: request.url,\n      method: request.method,\n      headers: toNodeOutgoingHttpHeaders(request.headers),\n      nextConfig: {\n        basePath: process.env.__NEXT_BASE_PATH,\n        i18n: process.env.__NEXT_I18N_CONFIG as any,\n        trailingSlash: Boolean(process.env.__NEXT_TRAILING_SLASH),\n        experimental: {\n          cacheLife: process.env.__NEXT_CACHE_LIFE as any,\n          authInterrupts: Boolean(\n            process.env.__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS\n          ),\n          clientParamParsingOrigins: process.env\n            .__NEXT_CLIENT_PARAM_PARSING_ORIGINS as any,\n        },\n      },\n      page: {\n        name: page,\n      },\n      body:\n        request.method !== 'GET' && request.method !== 'HEAD'\n          ? (request.body ?? undefined)\n          : undefined,\n      waitUntil: ctx.waitUntil,\n      requestMeta: ctx.requestMeta,\n      signal: ctx.signal || new AbortController().signal,\n    },\n  })\n\n  ctx.waitUntil?.(result.waitUntil)\n\n  return result.response\n}\n\n// backwards compat\nexport default internalHandler\n"],"names":["handler","mod","_mod","page","isProxy","handlerUserland","proxy","middleware","default","ProxyMissingExportError","Error","constructor","message","stack","errorHandledHandler","fn","args","err","process","env","NODE_ENV","isNextRouterError","req","url","URL","resource","pathname","search","edgeInstrumentationOnRequestError","path","method","headers","Object","fromEntries","entries","routerKind","routePath","routeType","revalidateReason","undefined","internalHandler","opts","adapter","request","ctx","result","toNodeOutgoingHttpHeaders","nextConfig","basePath","__NEXT_BASE_PATH","i18n","__NEXT_I18N_CONFIG","trailingSlash","Boolean","__NEXT_TRAILING_SLASH","experimental","cacheLife","__NEXT_CACHE_LIFE","authInterrupts","__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS","clientParamParsingOrigins","__NEXT_CLIENT_PARAM_PARSING_ORIGINS","name","body","waitUntil","requestMeta","signal","AbortController","response"],"mappings":"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","ignoreList":[0]}