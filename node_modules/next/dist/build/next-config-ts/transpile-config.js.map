{"version":3,"sources":["../../../src/build/next-config-ts/transpile-config.ts"],"sourcesContent":["import type { Options as SWCOptions } from '@swc/core'\nimport type { CompilerOptions } from 'typescript'\n\nimport path from 'node:path'\nimport { readFileSync, existsSync } from 'node:fs'\nimport { pathToFileURL } from 'node:url'\nimport * as CommentJson from 'next/dist/compiled/comment-json'\nimport { deregisterHook, registerHook, requireFromString } from './require-hook'\nimport { warn, warnOnce } from '../output/log'\nimport { getNodeOptionsArgs } from '../../server/lib/utils'\n\ntype RelevantCompilerOptions = Pick<CompilerOptions, 'paths' | 'baseUrl'>\n\nfunction resolveSWCOptions(\n  cwd: string,\n  compilerOptions: RelevantCompilerOptions\n): SWCOptions {\n  return {\n    jsc: {\n      parser: {\n        syntax: 'typescript',\n      },\n      ...(compilerOptions.paths ? { paths: compilerOptions.paths } : {}),\n      ...(compilerOptions.baseUrl\n        ? // Needs to be an absolute path.\n          { baseUrl: path.resolve(cwd, compilerOptions.baseUrl) }\n        : compilerOptions.paths\n          ? // If paths is given, baseUrl is required.\n            { baseUrl: cwd }\n          : {}),\n    },\n    module: {\n      type: 'commonjs',\n    },\n    isModule: 'unknown',\n    env: {\n      targets: {\n        // Setting the Node.js version can reduce unnecessary code generation.\n        node: process?.versions?.node ?? '20.19.0',\n      },\n    },\n  } satisfies SWCOptions\n}\n\nfunction resolveExtends(extendsPath: string, currentConfigDir: string): string {\n  // Relative paths are resolved relative to the current config's directory\n  if (\n    extendsPath.startsWith('./') ||\n    extendsPath.startsWith('../') ||\n    path.isAbsolute(extendsPath)\n  ) {\n    const resolved = path.resolve(currentConfigDir, extendsPath)\n    // TypeScript allows omitting .json extension\n    if (existsSync(resolved)) {\n      return resolved\n    }\n    if (!resolved.endsWith('.json') && existsSync(resolved + '.json')) {\n      return resolved + '.json'\n    }\n    return resolved\n  }\n\n  // Package paths - use require.resolve to find the package\n  try {\n    // Try resolving as a direct path within the package\n    return require.resolve(extendsPath, { paths: [currentConfigDir] })\n  } catch {\n    // If that fails, try appending tsconfig.json for package names like \"@tsconfig/node18\"\n    try {\n      return require.resolve(extendsPath + '/tsconfig.json', {\n        paths: [currentConfigDir],\n      })\n    } catch {\n      // Return the original path and let it fail later with a clear error\n      return path.resolve(currentConfigDir, extendsPath)\n    }\n  }\n}\n\nfunction loadTsConfigFile(\n  configPath: string,\n  visited: Set<string>\n): RelevantCompilerOptions {\n  const resolvedPath = path.resolve(configPath)\n\n  if (visited.has(resolvedPath)) {\n    return {}\n  }\n  visited.add(resolvedPath)\n\n  if (!existsSync(resolvedPath)) {\n    return {}\n  }\n\n  const configContent = readFileSync(resolvedPath, 'utf8')\n  const config = CommentJson.parse(configContent)\n  const configDir = path.dirname(resolvedPath)\n\n  let mergedOptions: RelevantCompilerOptions = {}\n\n  // Note that config options from `extends` should get overwritten, not merged\n  if (config.extends) {\n    const extendsList = Array.isArray(config.extends)\n      ? config.extends\n      : [config.extends]\n\n    for (const extendsPath of extendsList) {\n      const parentConfigPath = resolveExtends(extendsPath, configDir)\n      const parentOptions = loadTsConfigFile(parentConfigPath, visited)\n      mergedOptions = { ...mergedOptions, ...parentOptions }\n    }\n  }\n\n  const currentOptions = config.compilerOptions ?? {}\n  mergedOptions = {\n    ...mergedOptions,\n    paths: currentOptions.paths ?? mergedOptions.paths,\n    baseUrl: currentOptions.baseUrl ?? mergedOptions.baseUrl,\n  }\n\n  return mergedOptions\n}\n\nasync function loadTsConfig(dir: string): Promise<RelevantCompilerOptions> {\n  // NOTE: This doesn't fully cover the edge case for setting\n  // \"typescript.tsconfigPath\" in next config which is currently\n  // a restriction.\n  // It's a chicken-and-egg problem since we need to transpile\n  // the next config to get that value.\n  const resolvedTsConfigPath = path.join(dir, 'tsconfig.json')\n\n  if (!existsSync(resolvedTsConfigPath)) {\n    return {}\n  }\n\n  return loadTsConfigFile(resolvedTsConfigPath, new Set())\n}\n\nexport async function transpileConfig({\n  nextConfigPath,\n  dir,\n}: {\n  nextConfigPath: string\n  dir: string\n}) {\n  try {\n    // envs are passed to the workers and preserve the flag\n    if (process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED === 'true') {\n      try {\n        // Node.js v22.10.0+\n        // Value is 'strip' or 'transform' based on how the feature is enabled.\n        // https://nodejs.org/api/process.html#processfeaturestypescript\n        // TODO: Remove `as any` once we bump @types/node to v22.10.0+\n        if ((process.features as any).typescript) {\n          // Run import() here to catch errors and fallback to legacy resolution.\n          return (await import(pathToFileURL(nextConfigPath).href)).default\n        }\n\n        if (\n          getNodeOptionsArgs().includes('--no-experimental-strip-types') ||\n          process.execArgv.includes('--no-experimental-strip-types')\n        ) {\n          warnOnce(\n            `Skipped resolving \"${path.basename(nextConfigPath)}\" using Node.js native TypeScript resolution because it was disabled by the \"--no-experimental-strip-types\" flag.` +\n              ' Falling back to legacy resolution.' +\n              ' Learn more: https://nextjs.org/docs/app/api-reference/config/typescript#using-nodejs-native-typescript-resolver-for-nextconfigts'\n          )\n        }\n\n        // Feature is not enabled, fallback to legacy resolution for current session.\n        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n      } catch (cause) {\n        warnOnce(\n          `Failed to import \"${path.basename(nextConfigPath)}\" using Node.js native TypeScript resolution.` +\n            ' Falling back to legacy resolution.' +\n            ' Learn more: https://nextjs.org/docs/app/api-reference/config/typescript#using-nodejs-native-typescript-resolver-for-nextconfigts',\n          { cause }\n        )\n        // Once failed, fallback to legacy resolution for current session.\n        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n      }\n    }\n\n    const compilerOptions = await loadTsConfig(dir)\n    return handleCJS({ dir, nextConfigPath, compilerOptions })\n  } catch (cause) {\n    throw new Error(`Failed to transpile \"${path.basename(nextConfigPath)}\".`, {\n      cause,\n    })\n  }\n}\n\nasync function handleCJS({\n  dir,\n  nextConfigPath,\n  compilerOptions,\n}: {\n  dir: string\n  nextConfigPath: string\n  compilerOptions: RelevantCompilerOptions\n}) {\n  const swcOptions = resolveSWCOptions(dir, compilerOptions)\n  let hasRequire = false\n  try {\n    const nextConfigString = readFileSync(nextConfigPath, 'utf8')\n    // lazy require swc since it loads React before even setting NODE_ENV\n    // resulting loading Development React on Production\n    const { loadBindings } = require('../swc') as typeof import('../swc')\n    const bindings = await loadBindings()\n    const { code } = await bindings.transform(nextConfigString, swcOptions)\n\n    // register require hook only if require exists\n    if (code.includes('require(')) {\n      registerHook(swcOptions)\n      hasRequire = true\n    }\n\n    // filename & extension don't matter here\n    const config = requireFromString(\n      code,\n      path.resolve(dir, 'next.config.compiled.js')\n    )\n    // At this point we have already loaded the bindings without this configuration setting due to the `transform` call above.\n    // Possibly we fell back to wasm in which case, it all works out but if not we need to warn\n    // that the configuration was ignored.\n    if (config?.experimental?.useWasmBinary && !bindings.isWasm) {\n      warn(\n        'Using a next.config.ts file is incompatible with `experimental.useWasmBinary` unless ' +\n          '`--experimental-next-config-strip-types` is also passed.\\nSetting `useWasmBinary` to `false'\n      )\n      config.experimental.useWasmBinary = false\n    }\n    return config\n  } catch (error) {\n    throw error\n  } finally {\n    if (hasRequire) {\n      deregisterHook()\n    }\n  }\n}\n"],"names":["transpileConfig","resolveSWCOptions","cwd","compilerOptions","process","jsc","parser","syntax","paths","baseUrl","path","resolve","module","type","isModule","env","targets","node","versions","resolveExtends","extendsPath","currentConfigDir","startsWith","isAbsolute","resolved","existsSync","endsWith","require","loadTsConfigFile","configPath","visited","resolvedPath","has","add","configContent","readFileSync","config","CommentJson","parse","configDir","dirname","mergedOptions","extends","extendsList","Array","isArray","parentConfigPath","parentOptions","currentOptions","loadTsConfig","dir","resolvedTsConfigPath","join","Set","nextConfigPath","__NEXT_NODE_NATIVE_TS_LOADER_ENABLED","features","typescript","pathToFileURL","href","default","getNodeOptionsArgs","includes","execArgv","warnOnce","basename","cause","handleCJS","Error","swcOptions","hasRequire","nextConfigString","loadBindings","bindings","code","transform","registerHook","requireFromString","experimental","useWasmBinary","isWasm","warn","error","deregisterHook"],"mappings":"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","ignoreList":[0]}