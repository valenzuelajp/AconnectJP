{"version":3,"sources":["../../../src/build/turbopack-build/impl.ts"],"sourcesContent":["// Import cpu-profile first to start profiling early if enabled\nimport { saveCpuProfile } from '../../server/lib/cpu-profile'\nimport path from 'path'\nimport { validateTurboNextConfig } from '../../lib/turbopack-warning'\nimport { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\nimport { NextBuildContext } from '../build-context'\nimport { createDefineEnv, getBindingsSync } from '../swc'\nimport { installBindings } from '../swc/install-bindings'\nimport {\n  handleRouteType,\n  rawEntrypointsToEntrypoints,\n} from '../handle-entrypoints'\nimport { TurbopackManifestLoader } from '../../shared/lib/turbopack/manifest-loader'\nimport { promises as fs } from 'fs'\nimport { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\nimport loadConfig from '../../server/config'\nimport { hasCustomExportOutput } from '../../export/utils'\nimport { Telemetry } from '../../telemetry/storage'\nimport { setGlobal } from '../../trace'\nimport { isCI } from '../../server/ci-info'\nimport { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\nimport { getSupportedBrowsers, printBuildErrors } from '../utils'\nimport { normalizePath } from '../../lib/normalize-path'\nimport type { RawEntrypoints, TurbopackResult } from '../swc/types'\n\nexport async function turbopackBuild(): Promise<{\n  duration: number\n  buildTraceContext: undefined\n  shutdownPromise: Promise<void>\n}> {\n  await validateTurboNextConfig({\n    dir: NextBuildContext.dir!,\n    configPhase: PHASE_PRODUCTION_BUILD,\n  })\n\n  const config = NextBuildContext.config!\n  const dir = NextBuildContext.dir!\n  const distDir = NextBuildContext.distDir!\n  const buildId = NextBuildContext.buildId!\n  const encryptionKey = NextBuildContext.encryptionKey!\n  const previewProps = NextBuildContext.previewProps!\n  const hasRewrites = NextBuildContext.hasRewrites!\n  const rewrites = NextBuildContext.rewrites!\n  const noMangling = NextBuildContext.noMangling!\n  const currentNodeJsVersion = process.versions.node\n\n  const startTime = process.hrtime()\n  const bindings = getBindingsSync() // our caller should have already loaded these\n  const dev = false\n\n  const supportedBrowsers = getSupportedBrowsers(dir, dev)\n\n  const persistentCaching = isFileSystemCacheEnabledForBuild(config)\n  const rootPath = config.turbopack?.root || config.outputFileTracingRoot || dir\n  const project = await bindings.turbo.createProject(\n    {\n      rootPath: config.turbopack?.root || config.outputFileTracingRoot || dir,\n      projectPath: normalizePath(path.relative(rootPath, dir) || '.'),\n      distDir,\n      nextConfig: config,\n      watch: {\n        enable: false,\n      },\n      dev,\n      env: process.env as Record<string, string>,\n      defineEnv: createDefineEnv({\n        isTurbopack: true,\n        clientRouterFilters: NextBuildContext.clientRouterFilters!,\n        config,\n        dev,\n        distDir,\n        projectPath: dir,\n        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n        hasRewrites,\n        // Implemented separately in Turbopack, doesn't have to be passed here.\n        middlewareMatchers: undefined,\n        rewrites,\n      }),\n      buildId,\n      encryptionKey,\n      previewProps,\n      browserslistQuery: supportedBrowsers.join(', '),\n      noMangling,\n      writeRoutesHashesManifest:\n        !!process.env.NEXT_TURBOPACK_WRITE_ROUTES_HASHES_MANIFEST,\n      currentNodeJsVersion,\n      debugBuildPaths: NextBuildContext.debugBuildPaths,\n    },\n    {\n      persistentCaching,\n      memoryLimit: config.experimental?.turbopackMemoryLimit,\n      dependencyTracking: persistentCaching,\n      isCi: isCI,\n      isShortSession: true,\n    }\n  )\n  try {\n    backgroundLogCompilationEvents(project)\n\n    // Write an empty file in a known location to signal this was built with Turbopack\n    await fs.writeFile(path.join(distDir, 'turbopack'), '')\n\n    await fs.mkdir(path.join(distDir, 'server'), { recursive: true })\n    if (!config.deploymentId) {\n      await fs.mkdir(path.join(distDir, 'static', buildId), {\n        recursive: true,\n      })\n    }\n    await fs.writeFile(\n      path.join(distDir, 'package.json'),\n      '{\"type\": \"commonjs\"}'\n    )\n\n    let appDirOnly = NextBuildContext.appDirOnly!\n    const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n    printBuildErrors(entrypoints, dev)\n\n    let routes = entrypoints.routes\n    if (!routes) {\n      // This should never ever happen, there should be an error issue, or the bindings call should\n      // have thrown.\n      throw new Error(`Turbopack build failed`)\n    }\n\n    const hasPagesEntries = Array.from(routes.values()).some((route) => {\n      if (route.type === 'page' || route.type === 'page-api') {\n        return true\n      }\n      return false\n    })\n    // If there's no pages entries, then we are in app-dir-only mode\n    if (!hasPagesEntries) {\n      appDirOnly = true\n    }\n\n    const manifestLoader = new TurbopackManifestLoader({\n      buildId,\n      distDir,\n      encryptionKey,\n      dev: false,\n      deploymentId: config.deploymentId,\n    })\n\n    const currentEntrypoints = await rawEntrypointsToEntrypoints(\n      entrypoints as TurbopackResult<RawEntrypoints>\n    )\n\n    const promises: Promise<void>[] = []\n\n    if (!appDirOnly) {\n      for (const [page, route] of currentEntrypoints.page) {\n        promises.push(\n          handleRouteType({\n            page,\n            route,\n            manifestLoader,\n          })\n        )\n      }\n    }\n\n    for (const [page, route] of currentEntrypoints.app) {\n      promises.push(\n        handleRouteType({\n          page,\n          route,\n          manifestLoader,\n        })\n      )\n    }\n\n    await Promise.all(promises)\n\n    await Promise.all([\n      // Only load pages router manifests if not app-only\n      ...(!appDirOnly\n        ? [\n            manifestLoader.loadBuildManifest('_app'),\n            manifestLoader.loadPagesManifest('_app'),\n            manifestLoader.loadFontManifest('_app'),\n            manifestLoader.loadPagesManifest('_document'),\n            manifestLoader.loadClientBuildManifest('_error'),\n            manifestLoader.loadBuildManifest('_error'),\n            manifestLoader.loadPagesManifest('_error'),\n            manifestLoader.loadFontManifest('_error'),\n          ]\n        : []),\n      entrypoints.instrumentation &&\n        manifestLoader.loadMiddlewareManifest(\n          'instrumentation',\n          'instrumentation'\n        ),\n      entrypoints.middleware &&\n        (await manifestLoader.loadMiddlewareManifest(\n          'middleware',\n          'middleware'\n        )),\n    ])\n\n    manifestLoader.writeManifests({\n      devRewrites: undefined,\n      productionRewrites: rewrites,\n      entrypoints: currentEntrypoints,\n    })\n\n    if (NextBuildContext.analyze) {\n      await project.writeAnalyzeData(appDirOnly)\n    }\n\n    const shutdownPromise = project.shutdown()\n\n    const time = process.hrtime(startTime)\n    return {\n      duration: time[0] + time[1] / 1e9,\n      buildTraceContext: undefined,\n      shutdownPromise,\n    }\n  } catch (err) {\n    await project.shutdown()\n    throw err\n  }\n}\n\nlet shutdownPromise: Promise<void> | undefined\nexport async function workerMain(workerData: {\n  buildContext: typeof NextBuildContext\n}): Promise<\n  Omit<Awaited<ReturnType<typeof turbopackBuild>>, 'shutdownPromise'>\n> {\n  // setup new build context from the serialized data passed from the parent\n  Object.assign(NextBuildContext, workerData.buildContext)\n\n  /// load the config because it's not serializable\n  const config = (NextBuildContext.config = await loadConfig(\n    PHASE_PRODUCTION_BUILD,\n    NextBuildContext.dir!,\n    {\n      debugPrerender: NextBuildContext.debugPrerender,\n      reactProductionProfiling: NextBuildContext.reactProductionProfiling,\n    }\n  ))\n  // Matches handling in build/index.ts\n  // https://github.com/vercel/next.js/blob/84f347fc86f4efc4ec9f13615c215e4b9fb6f8f0/packages/next/src/build/index.ts#L815-L818\n  // Ensures the `config.distDir` option is matched.\n  if (hasCustomExportOutput(NextBuildContext.config)) {\n    NextBuildContext.config.distDir = '.next'\n  }\n\n  // Clone the telemetry for worker\n  const telemetry = new Telemetry({\n    distDir: NextBuildContext.config.distDir,\n  })\n  setGlobal('telemetry', telemetry)\n  // Install bindings early so we can access synchronously later\n  await installBindings(config.experimental?.useWasmBinary)\n\n  try {\n    const {\n      shutdownPromise: resultShutdownPromise,\n      buildTraceContext,\n      duration,\n    } = await turbopackBuild()\n    shutdownPromise = resultShutdownPromise\n    return {\n      buildTraceContext,\n      duration,\n    }\n  } finally {\n    // Always flush telemetry before worker exits (waits for async operations like setTimeout in debug mode)\n    await telemetry.flush()\n    // Save CPU profile before worker exits\n    await saveCpuProfile()\n  }\n}\n\nexport async function waitForShutdown(): Promise<void> {\n  if (shutdownPromise) {\n    await shutdownPromise\n  }\n}\n"],"names":["turbopackBuild","waitForShutdown","workerMain","config","validateTurboNextConfig","dir","NextBuildContext","configPhase","PHASE_PRODUCTION_BUILD","distDir","buildId","encryptionKey","previewProps","hasRewrites","rewrites","noMangling","currentNodeJsVersion","process","versions","node","startTime","hrtime","bindings","getBindingsSync","dev","supportedBrowsers","getSupportedBrowsers","persistentCaching","isFileSystemCacheEnabledForBuild","rootPath","turbopack","root","outputFileTracingRoot","project","turbo","createProject","projectPath","normalizePath","path","relative","nextConfig","watch","enable","env","defineEnv","createDefineEnv","isTurbopack","clientRouterFilters","fetchCacheKeyPrefix","experimental","middlewareMatchers","undefined","browserslistQuery","join","writeRoutesHashesManifest","NEXT_TURBOPACK_WRITE_ROUTES_HASHES_MANIFEST","debugBuildPaths","memoryLimit","turbopackMemoryLimit","dependencyTracking","isCi","isCI","isShortSession","backgroundLogCompilationEvents","fs","writeFile","mkdir","recursive","deploymentId","appDirOnly","entrypoints","writeAllEntrypointsToDisk","printBuildErrors","routes","Error","hasPagesEntries","Array","from","values","some","route","type","manifestLoader","TurbopackManifestLoader","currentEntrypoints","rawEntrypointsToEntrypoints","promises","page","push","handleRouteType","app","Promise","all","loadBuildManifest","loadPagesManifest","loadFontManifest","loadClientBuildManifest","instrumentation","loadMiddlewareManifest","middleware","writeManifests","devRewrites","productionRewrites","analyze","writeAnalyzeData","shutdownPromise","shutdown","time","duration","buildTraceContext","err","workerData","Object","assign","buildContext","loadConfig","debugPrerender","reactProductionProfiling","hasCustomExportOutput","telemetry","Telemetry","setGlobal","installBindings","useWasmBinary","resultShutdownPromise","flush","saveCpuProfile"],"mappings":"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","ignoreList":[0]}