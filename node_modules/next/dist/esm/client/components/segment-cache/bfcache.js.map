{"version":3,"sources":["../../../../../src/client/components/segment-cache/bfcache.ts"],"sourcesContent":["import type { SegmentVaryPath } from './vary-path'\nimport {\n  setInCacheMap,\n  getFromCacheMap,\n  type UnknownMapEntry,\n  type CacheMap,\n  createCacheMap,\n} from './cache-map'\nimport { DYNAMIC_STALETIME_MS } from '../router-reducer/reducers/navigate-reducer'\n\nexport type BFCacheEntry = {\n  rsc: React.ReactNode | null\n  prefetchRsc: React.ReactNode | null\n  head: React.ReactNode | null\n  prefetchHead: React.ReactNode | null\n\n  ref: UnknownMapEntry | null\n  size: number\n  staleAt: number\n  version: number\n}\n\nconst bfcacheMap: CacheMap<BFCacheEntry> = createCacheMap()\n\nlet currentBfCacheVersion = 0\n\nexport function invalidateBfCache(): void {\n  currentBfCacheVersion++\n}\n\nexport function writeToBFCache(\n  now: number,\n  varyPath: SegmentVaryPath,\n  rsc: React.ReactNode,\n  prefetchRsc: React.ReactNode,\n  head: React.ReactNode,\n  prefetchHead: React.ReactNode\n): void {\n  const entry: BFCacheEntry = {\n    rsc,\n    prefetchRsc,\n\n    // TODO: These fields will be removed from both BFCacheEntry and\n    // SegmentCacheEntry. The head has its own separate cache entry.\n    head,\n    prefetchHead,\n\n    ref: null,\n    // TODO: This is just a heuristic. Getting the actual size of the segment\n    // isn't feasible because it's part of a larger streaming response. The\n    // LRU will still evict it, we just won't have a fully accurate total\n    // LRU size. However, we'll probably remove the size tracking from the LRU\n    // entirely and use memory pressure events instead.\n    size: 100,\n\n    // A back/forward navigation will disregard the stale time. This field is\n    // only relevant when staleTimes.dynamic is enabled.\n    staleAt: now + DYNAMIC_STALETIME_MS,\n    version: currentBfCacheVersion,\n  }\n  const isRevalidation = false\n  setInCacheMap(bfcacheMap, varyPath, entry, isRevalidation)\n}\n\nexport function writeHeadToBFCache(\n  now: number,\n  varyPath: SegmentVaryPath,\n  head: React.ReactNode,\n  prefetchHead: React.ReactNode\n): void {\n  // Read the special \"segment\" that represents the head data.\n  writeToBFCache(now, varyPath, head, prefetchHead, null, null)\n}\n\nexport function readFromBFCache(\n  varyPath: SegmentVaryPath\n): BFCacheEntry | null {\n  const isRevalidation = false\n  return getFromCacheMap(\n    // During a back/forward navigation, it doesn't matter how stale the data\n    // might be. Pass -1 instead of the actual current time to bypass\n    // staleness checks.\n    -1,\n    currentBfCacheVersion,\n    bfcacheMap,\n    varyPath,\n    isRevalidation\n  )\n}\n\nexport function readFromBFCacheDuringRegularNavigation(\n  now: number,\n  varyPath: SegmentVaryPath\n): BFCacheEntry | null {\n  const isRevalidation = false\n  return getFromCacheMap(\n    now,\n    currentBfCacheVersion,\n    bfcacheMap,\n    varyPath,\n    isRevalidation\n  )\n}\n"],"names":["setInCacheMap","getFromCacheMap","createCacheMap","DYNAMIC_STALETIME_MS","bfcacheMap","currentBfCacheVersion","invalidateBfCache","writeToBFCache","now","varyPath","rsc","prefetchRsc","head","prefetchHead","entry","ref","size","staleAt","version","isRevalidation","writeHeadToBFCache","readFromBFCache","readFromBFCacheDuringRegularNavigation"],"mappings":"AACA,SACEA,aAAa,EACbC,eAAe,EAGfC,cAAc,QACT,cAAa;AACpB,SAASC,oBAAoB,QAAQ,8CAA6C;AAclF,MAAMC,aAAqCF;AAE3C,IAAIG,wBAAwB;AAE5B,OAAO,SAASC;IACdD;AACF;AAEA,OAAO,SAASE,eACdC,GAAW,EACXC,QAAyB,EACzBC,GAAoB,EACpBC,WAA4B,EAC5BC,IAAqB,EACrBC,YAA6B;IAE7B,MAAMC,QAAsB;QAC1BJ;QACAC;QAEA,gEAAgE;QAChE,gEAAgE;QAChEC;QACAC;QAEAE,KAAK;QACL,yEAAyE;QACzE,uEAAuE;QACvE,qEAAqE;QACrE,0EAA0E;QAC1E,mDAAmD;QACnDC,MAAM;QAEN,yEAAyE;QACzE,oDAAoD;QACpDC,SAAST,MAAML;QACfe,SAASb;IACX;IACA,MAAMc,iBAAiB;IACvBnB,cAAcI,YAAYK,UAAUK,OAAOK;AAC7C;AAEA,OAAO,SAASC,mBACdZ,GAAW,EACXC,QAAyB,EACzBG,IAAqB,EACrBC,YAA6B;IAE7B,4DAA4D;IAC5DN,eAAeC,KAAKC,UAAUG,MAAMC,cAAc,MAAM;AAC1D;AAEA,OAAO,SAASQ,gBACdZ,QAAyB;IAEzB,MAAMU,iBAAiB;IACvB,OAAOlB,gBACL,yEAAyE;IACzE,iEAAiE;IACjE,oBAAoB;IACpB,CAAC,GACDI,uBACAD,YACAK,UACAU;AAEJ;AAEA,OAAO,SAASG,uCACdd,GAAW,EACXC,QAAyB;IAEzB,MAAMU,iBAAiB;IACvB,OAAOlB,gBACLO,KACAH,uBACAD,YACAK,UACAU;AAEJ","ignoreList":[0]}