{"version":3,"sources":["../../../../../../src/client/components/router-reducer/reducers/refresh-reducer.ts"],"sourcesContent":["import type {\n  ReadonlyReducerState,\n  ReducerState,\n} from '../router-reducer-types'\nimport {\n  convertServerPatchToFullTree,\n  navigateToKnownRoute,\n} from '../../segment-cache/navigation'\nimport { invalidateSegmentCacheEntries } from '../../segment-cache/cache'\nimport { hasInterceptionRouteInCurrentTree } from './has-interception-route-in-current-tree'\nimport { FreshnessPolicy } from '../ppr-navigations'\nimport { invalidateBfCache } from '../../segment-cache/bfcache'\n\nexport function refreshReducer(state: ReadonlyReducerState): ReducerState {\n  // During a refresh, we invalidate the segment cache but not the route cache.\n  // The route cache contains the tree structure (which segments exist at a\n  // given URL) which doesn't change during a refresh. The segment cache\n  // contains the actual RSC data which needs to be re-fetched.\n  const currentNextUrl = state.nextUrl\n  const currentRouterState = state.tree\n  invalidateSegmentCacheEntries(currentNextUrl, currentRouterState)\n  return refreshDynamicData(state, FreshnessPolicy.RefreshAll)\n}\n\nexport function refreshDynamicData(\n  state: ReadonlyReducerState,\n  freshnessPolicy: FreshnessPolicy.RefreshAll | FreshnessPolicy.HMRRefresh\n): ReducerState {\n  // During a refresh, invalidate the BFCache, which may contain dynamic data.\n  invalidateBfCache()\n\n  const currentNextUrl = state.nextUrl\n\n  // We always send the last next-url, not the current when performing a dynamic\n  // request. This is because we update the next-url after a navigation, but we\n  // want the same interception route to be matched that used the last next-url.\n  const nextUrlForRefresh = hasInterceptionRouteInCurrentTree(state.tree)\n    ? state.previousNextUrl || currentNextUrl\n    : null\n\n  // A refresh is modeled as a navigation to the current URL, but where any\n  // existing dynamic data (including in shared layouts) is re-fetched.\n  const currentCanonicalUrl = state.canonicalUrl\n  const currentUrl = new URL(currentCanonicalUrl, location.origin)\n  const currentRenderedSearch = state.renderedSearch\n  const currentFlightRouterState = state.tree\n  const shouldScroll = false\n\n  // Create a NavigationSeed from the current FlightRouterState.\n  // TODO: Eventually we will store this type directly on the state object\n  // instead of reconstructing it on demand. Part of a larger series of\n  // refactors to unify the various tree types that the client deals with.\n  const refreshSeed = convertServerPatchToFullTree(\n    currentFlightRouterState,\n    null,\n    currentRenderedSearch\n  )\n\n  const now = Date.now()\n  const navigateType = 'replace'\n  return navigateToKnownRoute(\n    now,\n    state,\n    currentUrl,\n    currentCanonicalUrl,\n    refreshSeed,\n    currentUrl,\n    currentRenderedSearch,\n    state.cache,\n    currentFlightRouterState,\n    freshnessPolicy,\n    nextUrlForRefresh,\n    shouldScroll,\n    navigateType,\n    null,\n    // Refresh navigations don't use route prediction, so there's no route\n    // cache entry to mark as having a dynamic rewrite on mismatch. If a\n    // mismatch occurs, the retry handler will traverse the known route tree\n    // to find and mark the entry.\n    null\n  )\n}\n"],"names":["convertServerPatchToFullTree","navigateToKnownRoute","invalidateSegmentCacheEntries","hasInterceptionRouteInCurrentTree","FreshnessPolicy","invalidateBfCache","refreshReducer","state","currentNextUrl","nextUrl","currentRouterState","tree","refreshDynamicData","RefreshAll","freshnessPolicy","nextUrlForRefresh","previousNextUrl","currentCanonicalUrl","canonicalUrl","currentUrl","URL","location","origin","currentRenderedSearch","renderedSearch","currentFlightRouterState","shouldScroll","refreshSeed","now","Date","navigateType","cache"],"mappings":"AAIA,SACEA,4BAA4B,EAC5BC,oBAAoB,QACf,iCAAgC;AACvC,SAASC,6BAA6B,QAAQ,4BAA2B;AACzE,SAASC,iCAAiC,QAAQ,2CAA0C;AAC5F,SAASC,eAAe,QAAQ,qBAAoB;AACpD,SAASC,iBAAiB,QAAQ,8BAA6B;AAE/D,OAAO,SAASC,eAAeC,KAA2B;IACxD,6EAA6E;IAC7E,yEAAyE;IACzE,sEAAsE;IACtE,6DAA6D;IAC7D,MAAMC,iBAAiBD,MAAME,OAAO;IACpC,MAAMC,qBAAqBH,MAAMI,IAAI;IACrCT,8BAA8BM,gBAAgBE;IAC9C,OAAOE,mBAAmBL,OAAOH,gBAAgBS,UAAU;AAC7D;AAEA,OAAO,SAASD,mBACdL,KAA2B,EAC3BO,eAAwE;IAExE,4EAA4E;IAC5ET;IAEA,MAAMG,iBAAiBD,MAAME,OAAO;IAEpC,8EAA8E;IAC9E,6EAA6E;IAC7E,8EAA8E;IAC9E,MAAMM,oBAAoBZ,kCAAkCI,MAAMI,IAAI,IAClEJ,MAAMS,eAAe,IAAIR,iBACzB;IAEJ,yEAAyE;IACzE,qEAAqE;IACrE,MAAMS,sBAAsBV,MAAMW,YAAY;IAC9C,MAAMC,aAAa,IAAIC,IAAIH,qBAAqBI,SAASC,MAAM;IAC/D,MAAMC,wBAAwBhB,MAAMiB,cAAc;IAClD,MAAMC,2BAA2BlB,MAAMI,IAAI;IAC3C,MAAMe,eAAe;IAErB,8DAA8D;IAC9D,wEAAwE;IACxE,qEAAqE;IACrE,wEAAwE;IACxE,MAAMC,cAAc3B,6BAClByB,0BACA,MACAF;IAGF,MAAMK,MAAMC,KAAKD,GAAG;IACpB,MAAME,eAAe;IACrB,OAAO7B,qBACL2B,KACArB,OACAY,YACAF,qBACAU,aACAR,YACAI,uBACAhB,MAAMwB,KAAK,EACXN,0BACAX,iBACAC,mBACAW,cACAI,cACA,MACA,sEAAsE;IACtE,oEAAoE;IACpE,wEAAwE;IACxE,8BAA8B;IAC9B;AAEJ","ignoreList":[0]}