{"version":3,"sources":["../../../../src/build/next-config-ts/transpile-config.ts"],"sourcesContent":["import type { Options as SWCOptions } from '@swc/core'\nimport type { CompilerOptions } from 'typescript'\n\nimport path from 'node:path'\nimport { readFileSync, existsSync } from 'node:fs'\nimport { pathToFileURL } from 'node:url'\nimport * as CommentJson from 'next/dist/compiled/comment-json'\nimport { deregisterHook, registerHook, requireFromString } from './require-hook'\nimport { warn, warnOnce } from '../output/log'\nimport { getNodeOptionsArgs } from '../../server/lib/utils'\n\ntype RelevantCompilerOptions = Pick<CompilerOptions, 'paths' | 'baseUrl'>\n\nfunction resolveSWCOptions(\n  cwd: string,\n  compilerOptions: RelevantCompilerOptions\n): SWCOptions {\n  return {\n    jsc: {\n      parser: {\n        syntax: 'typescript',\n      },\n      ...(compilerOptions.paths ? { paths: compilerOptions.paths } : {}),\n      ...(compilerOptions.baseUrl\n        ? // Needs to be an absolute path.\n          { baseUrl: path.resolve(cwd, compilerOptions.baseUrl) }\n        : compilerOptions.paths\n          ? // If paths is given, baseUrl is required.\n            { baseUrl: cwd }\n          : {}),\n    },\n    module: {\n      type: 'commonjs',\n    },\n    isModule: 'unknown',\n    env: {\n      targets: {\n        // Setting the Node.js version can reduce unnecessary code generation.\n        node: process?.versions?.node ?? '20.19.0',\n      },\n    },\n  } satisfies SWCOptions\n}\n\nfunction resolveExtends(extendsPath: string, currentConfigDir: string): string {\n  // Relative paths are resolved relative to the current config's directory\n  if (\n    extendsPath.startsWith('./') ||\n    extendsPath.startsWith('../') ||\n    path.isAbsolute(extendsPath)\n  ) {\n    const resolved = path.resolve(currentConfigDir, extendsPath)\n    // TypeScript allows omitting .json extension\n    if (existsSync(resolved)) {\n      return resolved\n    }\n    if (!resolved.endsWith('.json') && existsSync(resolved + '.json')) {\n      return resolved + '.json'\n    }\n    return resolved\n  }\n\n  // Package paths - use require.resolve to find the package\n  try {\n    // Try resolving as a direct path within the package\n    return require.resolve(extendsPath, { paths: [currentConfigDir] })\n  } catch {\n    // If that fails, try appending tsconfig.json for package names like \"@tsconfig/node18\"\n    try {\n      return require.resolve(extendsPath + '/tsconfig.json', {\n        paths: [currentConfigDir],\n      })\n    } catch {\n      // Return the original path and let it fail later with a clear error\n      return path.resolve(currentConfigDir, extendsPath)\n    }\n  }\n}\n\nfunction loadTsConfigFile(\n  configPath: string,\n  visited: Set<string>\n): RelevantCompilerOptions {\n  const resolvedPath = path.resolve(configPath)\n\n  if (visited.has(resolvedPath)) {\n    return {}\n  }\n  visited.add(resolvedPath)\n\n  if (!existsSync(resolvedPath)) {\n    return {}\n  }\n\n  const configContent = readFileSync(resolvedPath, 'utf8')\n  const config = CommentJson.parse(configContent)\n  const configDir = path.dirname(resolvedPath)\n\n  let mergedOptions: RelevantCompilerOptions = {}\n\n  // Note that config options from `extends` should get overwritten, not merged\n  if (config.extends) {\n    const extendsList = Array.isArray(config.extends)\n      ? config.extends\n      : [config.extends]\n\n    for (const extendsPath of extendsList) {\n      const parentConfigPath = resolveExtends(extendsPath, configDir)\n      const parentOptions = loadTsConfigFile(parentConfigPath, visited)\n      mergedOptions = { ...mergedOptions, ...parentOptions }\n    }\n  }\n\n  const currentOptions = config.compilerOptions ?? {}\n  mergedOptions = {\n    ...mergedOptions,\n    paths: currentOptions.paths ?? mergedOptions.paths,\n    baseUrl: currentOptions.baseUrl ?? mergedOptions.baseUrl,\n  }\n\n  return mergedOptions\n}\n\nasync function loadTsConfig(dir: string): Promise<RelevantCompilerOptions> {\n  // NOTE: This doesn't fully cover the edge case for setting\n  // \"typescript.tsconfigPath\" in next config which is currently\n  // a restriction.\n  // It's a chicken-and-egg problem since we need to transpile\n  // the next config to get that value.\n  const resolvedTsConfigPath = path.join(dir, 'tsconfig.json')\n\n  if (!existsSync(resolvedTsConfigPath)) {\n    return {}\n  }\n\n  return loadTsConfigFile(resolvedTsConfigPath, new Set())\n}\n\nexport async function transpileConfig({\n  nextConfigPath,\n  dir,\n}: {\n  nextConfigPath: string\n  dir: string\n}) {\n  try {\n    // envs are passed to the workers and preserve the flag\n    if (process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED === 'true') {\n      try {\n        // Node.js v22.10.0+\n        // Value is 'strip' or 'transform' based on how the feature is enabled.\n        // https://nodejs.org/api/process.html#processfeaturestypescript\n        // TODO: Remove `as any` once we bump @types/node to v22.10.0+\n        if ((process.features as any).typescript) {\n          // Run import() here to catch errors and fallback to legacy resolution.\n          return (await import(pathToFileURL(nextConfigPath).href)).default\n        }\n\n        if (\n          getNodeOptionsArgs().includes('--no-experimental-strip-types') ||\n          process.execArgv.includes('--no-experimental-strip-types')\n        ) {\n          warnOnce(\n            `Skipped resolving \"${path.basename(nextConfigPath)}\" using Node.js native TypeScript resolution because it was disabled by the \"--no-experimental-strip-types\" flag.` +\n              ' Falling back to legacy resolution.' +\n              ' Learn more: https://nextjs.org/docs/app/api-reference/config/typescript#using-nodejs-native-typescript-resolver-for-nextconfigts'\n          )\n        }\n\n        // Feature is not enabled, fallback to legacy resolution for current session.\n        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n      } catch (cause) {\n        warnOnce(\n          `Failed to import \"${path.basename(nextConfigPath)}\" using Node.js native TypeScript resolution.` +\n            ' Falling back to legacy resolution.' +\n            ' Learn more: https://nextjs.org/docs/app/api-reference/config/typescript#using-nodejs-native-typescript-resolver-for-nextconfigts',\n          { cause }\n        )\n        // Once failed, fallback to legacy resolution for current session.\n        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n      }\n    }\n\n    const compilerOptions = await loadTsConfig(dir)\n    return handleCJS({ dir, nextConfigPath, compilerOptions })\n  } catch (cause) {\n    throw new Error(`Failed to transpile \"${path.basename(nextConfigPath)}\".`, {\n      cause,\n    })\n  }\n}\n\nasync function handleCJS({\n  dir,\n  nextConfigPath,\n  compilerOptions,\n}: {\n  dir: string\n  nextConfigPath: string\n  compilerOptions: RelevantCompilerOptions\n}) {\n  const swcOptions = resolveSWCOptions(dir, compilerOptions)\n  let hasRequire = false\n  try {\n    const nextConfigString = readFileSync(nextConfigPath, 'utf8')\n    // lazy require swc since it loads React before even setting NODE_ENV\n    // resulting loading Development React on Production\n    const { loadBindings } = require('../swc') as typeof import('../swc')\n    const bindings = await loadBindings()\n    const { code } = await bindings.transform(nextConfigString, swcOptions)\n\n    // register require hook only if require exists\n    if (code.includes('require(')) {\n      registerHook(swcOptions)\n      hasRequire = true\n    }\n\n    // filename & extension don't matter here\n    const config = requireFromString(\n      code,\n      path.resolve(dir, 'next.config.compiled.js')\n    )\n    // At this point we have already loaded the bindings without this configuration setting due to the `transform` call above.\n    // Possibly we fell back to wasm in which case, it all works out but if not we need to warn\n    // that the configuration was ignored.\n    if (config?.experimental?.useWasmBinary && !bindings.isWasm) {\n      warn(\n        'Using a next.config.ts file is incompatible with `experimental.useWasmBinary` unless ' +\n          '`--experimental-next-config-strip-types` is also passed.\\nSetting `useWasmBinary` to `false'\n      )\n      config.experimental.useWasmBinary = false\n    }\n    return config\n  } catch (error) {\n    throw error\n  } finally {\n    if (hasRequire) {\n      deregisterHook()\n    }\n  }\n}\n"],"names":["path","readFileSync","existsSync","pathToFileURL","CommentJson","deregisterHook","registerHook","requireFromString","warn","warnOnce","getNodeOptionsArgs","resolveSWCOptions","cwd","compilerOptions","process","jsc","parser","syntax","paths","baseUrl","resolve","module","type","isModule","env","targets","node","versions","resolveExtends","extendsPath","currentConfigDir","startsWith","isAbsolute","resolved","endsWith","require","loadTsConfigFile","configPath","visited","resolvedPath","has","add","configContent","config","parse","configDir","dirname","mergedOptions","extends","extendsList","Array","isArray","parentConfigPath","parentOptions","currentOptions","loadTsConfig","dir","resolvedTsConfigPath","join","Set","transpileConfig","nextConfigPath","__NEXT_NODE_NATIVE_TS_LOADER_ENABLED","features","typescript","href","default","includes","execArgv","basename","cause","handleCJS","Error","swcOptions","hasRequire","nextConfigString","loadBindings","bindings","code","transform","experimental","useWasmBinary","isWasm","error"],"mappings":"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","ignoreList":[0]}