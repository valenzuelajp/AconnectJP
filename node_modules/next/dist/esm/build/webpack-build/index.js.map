{"version":3,"sources":["../../../../src/build/webpack-build/index.ts"],"sourcesContent":["import type { COMPILER_INDEXES } from '../../shared/lib/constants'\nimport * as Log from '../output/log'\nimport { NextBuildContext } from '../build-context'\nimport type { BuildTraceContext } from '../webpack/plugins/next-trace-entrypoints-plugin'\nimport { Worker } from '../../lib/worker'\nimport origDebug from 'next/dist/compiled/debug'\nimport path from 'path'\nimport { exportTraceState, recordTraceEvents } from '../../trace'\nimport { mergeUseCacheTrackers } from '../webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\nimport { durationToString } from '../duration-to-string'\n\nconst debug = origDebug('next:build:webpack-build')\n\nconst ORDERED_COMPILER_NAMES = [\n  'server',\n  'edge-server',\n  'client',\n] as (keyof typeof COMPILER_INDEXES)[]\n\nlet pluginState: Record<any, any> = {}\n\nfunction deepMerge(target: any, source: any) {\n  const result = { ...target, ...source }\n  for (const key of Object.keys(result)) {\n    result[key] = Array.isArray(target[key])\n      ? (target[key] = [...target[key], ...(source[key] || [])])\n      : typeof target[key] == 'object' && typeof source[key] == 'object'\n        ? deepMerge(target[key], source[key])\n        : result[key]\n  }\n  return result\n}\n\nasync function webpackBuildWithWorker(\n  compilerNamesArg: typeof ORDERED_COMPILER_NAMES | null\n) {\n  const compilerNames = compilerNamesArg || ORDERED_COMPILER_NAMES\n  const { nextBuildSpan, ...prunedBuildContext } = NextBuildContext\n\n  prunedBuildContext.pluginState = pluginState\n\n  const combinedResult = {\n    duration: 0,\n    buildTraceContext: {} as BuildTraceContext,\n  }\n\n  for (const compilerName of compilerNames) {\n    const worker = new Worker(path.join(__dirname, 'impl.js'), {\n      exposedMethods: ['workerMain'],\n      debuggerPortOffset: -1,\n      isolatedMemory: false,\n      numWorkers: 1,\n      maxRetries: 0,\n      forkOptions: {\n        env: {\n          NEXT_PRIVATE_BUILD_WORKER: '1',\n          ...(process.env.NEXT_CPU_PROF\n            ? {\n                NEXT_CPU_PROF: '1',\n                NEXT_CPU_PROF_DIR: process.env.NEXT_CPU_PROF_DIR,\n                __NEXT_PRIVATE_CPU_PROFILE: `build-webpack-${compilerName}`,\n              }\n            : undefined),\n        },\n      },\n    }) as Worker & typeof import('./impl')\n\n    const curResult = await worker.workerMain({\n      buildContext: prunedBuildContext,\n      compilerName,\n      traceState: {\n        ...exportTraceState(),\n        defaultParentSpanId: nextBuildSpan?.getId(),\n        shouldSaveTraceEvents: true,\n      },\n    })\n    if (nextBuildSpan && curResult.debugTraceEvents) {\n      recordTraceEvents(curResult.debugTraceEvents)\n    }\n    // destroy worker so it's not sticking around using memory\n    await worker.end()\n\n    // Update plugin state\n    pluginState = deepMerge(pluginState, curResult.pluginState)\n    prunedBuildContext.pluginState = pluginState\n\n    if (curResult.telemetryState) {\n      NextBuildContext.telemetryState = {\n        ...curResult.telemetryState,\n        useCacheTracker: mergeUseCacheTrackers(\n          NextBuildContext.telemetryState?.useCacheTracker,\n          curResult.telemetryState.useCacheTracker\n        ),\n      }\n    }\n\n    combinedResult.duration += curResult.duration\n\n    if (curResult.buildTraceContext?.entriesTrace) {\n      const { entryNameMap } = curResult.buildTraceContext.entriesTrace!\n\n      if (entryNameMap) {\n        combinedResult.buildTraceContext.entriesTrace =\n          curResult.buildTraceContext.entriesTrace\n        combinedResult.buildTraceContext.entriesTrace!.entryNameMap =\n          entryNameMap\n      }\n\n      if (curResult.buildTraceContext?.chunksTrace) {\n        const { entryNameFilesMap } = curResult.buildTraceContext.chunksTrace!\n\n        if (entryNameFilesMap) {\n          combinedResult.buildTraceContext.chunksTrace =\n            curResult.buildTraceContext.chunksTrace!\n\n          combinedResult.buildTraceContext.chunksTrace!.entryNameFilesMap =\n            entryNameFilesMap\n        }\n      }\n    }\n  }\n\n  if (compilerNames.length === 3) {\n    const durationString = durationToString(combinedResult.duration)\n    Log.event(`Compiled successfully in ${durationString}`)\n  }\n\n  return combinedResult\n}\n\nexport async function webpackBuild(\n  withWorker: boolean,\n  compilerNames: typeof ORDERED_COMPILER_NAMES | null\n): Promise<\n  | Awaited<ReturnType<typeof webpackBuildWithWorker>>\n  | Awaited<ReturnType<typeof import('./impl').webpackBuildImpl>>\n> {\n  const nextBuildSpan = NextBuildContext.nextBuildSpan!\n  return nextBuildSpan.traceChild('run-webpack').traceAsyncFn(async () => {\n    if (withWorker) {\n      debug('using separate compiler workers')\n      return await webpackBuildWithWorker(compilerNames)\n    } else {\n      debug('building all compilers in same process')\n      const webpackBuildImpl = (require('./impl') as typeof import('./impl'))\n        .webpackBuildImpl\n      const curResult = await webpackBuildImpl(null)\n\n      // Mirror what happens in webpackBuildWithWorker\n      if (curResult.telemetryState) {\n        NextBuildContext.telemetryState = {\n          ...curResult.telemetryState,\n          useCacheTracker: mergeUseCacheTrackers(\n            NextBuildContext.telemetryState?.useCacheTracker,\n            curResult.telemetryState.useCacheTracker\n          ),\n        }\n      }\n\n      return curResult\n    }\n  })\n}\n"],"names":["Log","NextBuildContext","Worker","origDebug","path","exportTraceState","recordTraceEvents","mergeUseCacheTrackers","durationToString","debug","ORDERED_COMPILER_NAMES","pluginState","deepMerge","target","source","result","key","Object","keys","Array","isArray","webpackBuildWithWorker","compilerNamesArg","compilerNames","nextBuildSpan","prunedBuildContext","combinedResult","duration","buildTraceContext","compilerName","curResult","worker","join","__dirname","exposedMethods","debuggerPortOffset","isolatedMemory","numWorkers","maxRetries","forkOptions","env","NEXT_PRIVATE_BUILD_WORKER","process","NEXT_CPU_PROF","NEXT_CPU_PROF_DIR","__NEXT_PRIVATE_CPU_PROFILE","undefined","workerMain","buildContext","traceState","defaultParentSpanId","getId","shouldSaveTraceEvents","debugTraceEvents","end","telemetryState","useCacheTracker","entriesTrace","entryNameMap","chunksTrace","entryNameFilesMap","length","durationString","event","webpackBuild","withWorker","traceChild","traceAsyncFn","webpackBuildImpl","require"],"mappings":"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","ignoreList":[0]}