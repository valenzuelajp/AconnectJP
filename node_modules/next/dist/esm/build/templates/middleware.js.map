{"version":3,"sources":["../../../../src/build/templates/middleware.ts"],"sourcesContent":["import type { AdapterOptions, EdgeHandler } from '../../server/web/adapter'\nimport '../adapter/setup-node-env.external'\nimport '../../server/web/globals'\n\nimport { adapter } from '../../server/web/adapter'\n\n// Import the userland code.\nimport * as _mod from 'VAR_USERLAND'\nimport { edgeInstrumentationOnRequestError } from '../../server/web/globals'\nimport { isNextRouterError } from '../../client/components/is-next-router-error'\nimport { toNodeOutgoingHttpHeaders } from '../../server/web/utils'\nimport type { RequestMeta } from '../../server/request-meta'\n\nconst mod = { ..._mod }\n\nconst page: string = 'VAR_DEFINITION_PAGE'\nconst isProxy = page === '/proxy' || page === '/src/proxy'\nconst handlerUserland = (isProxy ? mod.proxy : mod.middleware) || mod.default\n\nclass ProxyMissingExportError extends Error {\n  constructor(message: string) {\n    super(message)\n    // Stack isn't useful here, remove it considering it spams logs during development.\n    this.stack = ''\n  }\n}\n\n// TODO: This spams logs during development. Find a better way to handle this.\n// Removing this will spam \"fn is not a function\" logs which is worse.\nif (typeof handlerUserland !== 'function') {\n  throw new ProxyMissingExportError(\n    `The ${isProxy ? 'Proxy' : 'Middleware'} file \"${page}\" must export a function named \\`${isProxy ? 'proxy' : 'middleware'}\\` or a default function.`\n  )\n}\n\n// Proxy will only sent out the FetchEvent to next server,\n// so load instrumentation module here and track the error inside proxy module.\nfunction errorHandledHandler(fn: AdapterOptions['handler']) {\n  return async (...args: Parameters<AdapterOptions['handler']>) => {\n    try {\n      return await fn(...args)\n    } catch (err) {\n      // In development, error the navigation API usage in runtime,\n      // since it's not allowed to be used in proxy as it's outside of react component tree.\n      if (process.env.NODE_ENV !== 'production') {\n        if (isNextRouterError(err)) {\n          err.message = `Next.js navigation API is not allowed to be used in ${isProxy ? 'Proxy' : 'Middleware'}.`\n          throw err\n        }\n      }\n      const req = args[0]\n      const url = new URL(req.url)\n      const resource = url.pathname + url.search\n      await edgeInstrumentationOnRequestError(\n        err,\n        {\n          path: resource,\n          method: req.method,\n          headers: Object.fromEntries(req.headers.entries()),\n        },\n        {\n          routerKind: 'Pages Router',\n          routePath: '/proxy',\n          routeType: 'proxy',\n          revalidateReason: undefined,\n        }\n      )\n\n      throw err\n    }\n  }\n}\n\nconst internalHandler: EdgeHandler = (opts) => {\n  return adapter({\n    ...opts,\n    page,\n    handler: errorHandledHandler(handlerUserland),\n  })\n}\n\nexport async function handler(\n  request: Request,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n    signal?: AbortSignal\n    requestMeta?: RequestMeta\n  }\n): Promise<Response> {\n  const result = await internalHandler({\n    request: {\n      url: request.url,\n      method: request.method,\n      headers: toNodeOutgoingHttpHeaders(request.headers),\n      nextConfig: {\n        basePath: process.env.__NEXT_BASE_PATH,\n        i18n: process.env.__NEXT_I18N_CONFIG as any,\n        trailingSlash: Boolean(process.env.__NEXT_TRAILING_SLASH),\n        experimental: {\n          cacheLife: process.env.__NEXT_CACHE_LIFE as any,\n          authInterrupts: Boolean(\n            process.env.__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS\n          ),\n          clientParamParsingOrigins: process.env\n            .__NEXT_CLIENT_PARAM_PARSING_ORIGINS as any,\n        },\n      },\n      page: {\n        name: page,\n      },\n      body:\n        request.method !== 'GET' && request.method !== 'HEAD'\n          ? (request.body ?? undefined)\n          : undefined,\n      waitUntil: ctx.waitUntil,\n      requestMeta: ctx.requestMeta,\n      signal: ctx.signal || new AbortController().signal,\n    },\n  })\n\n  ctx.waitUntil?.(result.waitUntil)\n\n  return result.response\n}\n\n// backwards compat\nexport default internalHandler\n"],"names":["adapter","_mod","edgeInstrumentationOnRequestError","isNextRouterError","toNodeOutgoingHttpHeaders","mod","page","isProxy","handlerUserland","proxy","middleware","default","ProxyMissingExportError","Error","constructor","message","stack","errorHandledHandler","fn","args","err","process","env","NODE_ENV","req","url","URL","resource","pathname","search","path","method","headers","Object","fromEntries","entries","routerKind","routePath","routeType","revalidateReason","undefined","internalHandler","opts","handler","request","ctx","result","nextConfig","basePath","__NEXT_BASE_PATH","i18n","__NEXT_I18N_CONFIG","trailingSlash","Boolean","__NEXT_TRAILING_SLASH","experimental","cacheLife","__NEXT_CACHE_LIFE","authInterrupts","__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS","clientParamParsingOrigins","__NEXT_CLIENT_PARAM_PARSING_ORIGINS","name","body","waitUntil","requestMeta","signal","AbortController","response"],"mappings":"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","ignoreList":[0]}