{"version":3,"sources":["../../../src/build/after-production-compile.ts"],"sourcesContent":["import type { NextConfigComplete } from '../server/config-shared'\nimport type { Span } from '../trace'\n\nimport * as Log from './output/log'\nimport createSpinner from './spinner'\nimport isError from '../lib/is-error'\nimport type { Telemetry } from '../telemetry/storage'\nimport { EVENT_BUILD_FEATURE_USAGE } from '../telemetry/events/build'\nimport { hrtimeBigIntDurationToString } from './duration-to-string'\n\n// TODO: refactor this to account for more compiler lifecycle events\n// such as beforeProductionBuild, but for now this is the only one that is needed\nexport async function runAfterProductionCompile({\n  config,\n  buildSpan,\n  telemetry,\n  metadata,\n}: {\n  config: NextConfigComplete\n  buildSpan: Span\n  telemetry: Telemetry\n  metadata: {\n    projectDir: string\n    distDir: string\n  }\n}): Promise<void> {\n  const run = config.compiler.runAfterProductionCompile\n  if (!run) {\n    return\n  }\n  telemetry.record([\n    {\n      eventName: EVENT_BUILD_FEATURE_USAGE,\n      payload: {\n        featureName: 'runAfterProductionCompile',\n        invocationCount: 1,\n      },\n    },\n  ])\n  const afterBuildSpinner = createSpinner(\n    'Running next.config.js provided runAfterProductionCompile'\n  )\n\n  try {\n    const startTime = process.hrtime.bigint()\n    await buildSpan\n      .traceChild('after-production-compile')\n      .traceAsyncFn(async () => {\n        await run(metadata)\n      })\n    const duration = process.hrtime.bigint() - startTime\n    const formattedDuration = hrtimeBigIntDurationToString(duration)\n    Log.event(`Completed runAfterProductionCompile in ${formattedDuration}`)\n  } catch (err) {\n    // Handle specific known errors differently if needed\n    if (isError(err)) {\n      Log.error(`Failed to run runAfterProductionCompile: ${err.message}`)\n    }\n\n    throw err\n  } finally {\n    afterBuildSpinner?.stop()\n  }\n}\n"],"names":["Log","createSpinner","isError","EVENT_BUILD_FEATURE_USAGE","hrtimeBigIntDurationToString","runAfterProductionCompile","config","buildSpan","telemetry","metadata","run","compiler","record","eventName","payload","featureName","invocationCount","afterBuildSpinner","startTime","process","hrtime","bigint","traceChild","traceAsyncFn","duration","formattedDuration","event","err","error","message","stop"],"mappings":"AAGA,YAAYA,SAAS,eAAc;AACnC,OAAOC,mBAAmB,YAAW;AACrC,OAAOC,aAAa,kBAAiB;AAErC,SAASC,yBAAyB,QAAQ,4BAA2B;AACrE,SAASC,4BAA4B,QAAQ,uBAAsB;AAEnE,oEAAoE;AACpE,iFAAiF;AACjF,OAAO,eAAeC,0BAA0B,EAC9CC,MAAM,EACNC,SAAS,EACTC,SAAS,EACTC,QAAQ,EAST;IACC,MAAMC,MAAMJ,OAAOK,QAAQ,CAACN,yBAAyB;IACrD,IAAI,CAACK,KAAK;QACR;IACF;IACAF,UAAUI,MAAM,CAAC;QACf;YACEC,WAAWV;YACXW,SAAS;gBACPC,aAAa;gBACbC,iBAAiB;YACnB;QACF;KACD;IACD,MAAMC,oBAAoBhB,cACxB;IAGF,IAAI;QACF,MAAMiB,YAAYC,QAAQC,MAAM,CAACC,MAAM;QACvC,MAAMd,UACHe,UAAU,CAAC,4BACXC,YAAY,CAAC;YACZ,MAAMb,IAAID;QACZ;QACF,MAAMe,WAAWL,QAAQC,MAAM,CAACC,MAAM,KAAKH;QAC3C,MAAMO,oBAAoBrB,6BAA6BoB;QACvDxB,IAAI0B,KAAK,CAAC,CAAC,uCAAuC,EAAED,mBAAmB;IACzE,EAAE,OAAOE,KAAK;QACZ,qDAAqD;QACrD,IAAIzB,QAAQyB,MAAM;YAChB3B,IAAI4B,KAAK,CAAC,CAAC,yCAAyC,EAAED,IAAIE,OAAO,EAAE;QACrE;QAEA,MAAMF;IACR,SAAU;QACRV,qCAAAA,kBAAmBa,IAAI;IACzB;AACF","ignoreList":[0]}