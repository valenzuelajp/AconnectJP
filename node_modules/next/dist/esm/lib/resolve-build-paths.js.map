{"version":3,"sources":["../../../src/lib/resolve-build-paths.ts"],"sourcesContent":["import { promisify } from 'util'\nimport globOriginal from 'next/dist/compiled/glob'\nimport * as Log from '../build/output/log'\nimport path from 'path'\nimport fs from 'fs'\nimport isError from './is-error'\n\nconst glob = promisify(globOriginal)\n\ninterface ResolvedBuildPaths {\n  appPaths: string[]\n  pagePaths: string[]\n}\n\n/**\n * Escapes Next.js dynamic route bracket expressions so glob treats them as\n * literal directory names rather than character classes.\n *\n * e.g., \"app/blog/[slug]/** /page.tsx\" → \"app/blog/\\[slug\\]/** /page.tsx\"\n */\nfunction escapeBrackets(pattern: string): string {\n  // Match Next.js dynamic route patterns: [name], [...name], [[...name]]\n  return pattern.replace(/\\[\\[?\\.\\.\\.[^\\]]+\\]?\\]|\\[[^\\]]+\\]/g, (match) =>\n    match.replace(/\\[/g, '\\\\[').replace(/\\]/g, '\\\\]')\n  )\n}\n\n/**\n * Resolves glob patterns and explicit paths to actual file paths.\n * Categorizes them into App Router and Pages Router paths.\n *\n * Supports negation patterns prefixed with \"!\" to exclude paths.\n * e.g., \"app/**,!app/[lang]/page.js\" includes all App Router paths except\n * app/[lang]/page.js\n */\nexport async function resolveBuildPaths(\n  patterns: string[],\n  projectDir: string\n): Promise<ResolvedBuildPaths> {\n  const appPaths: Set<string> = new Set()\n  const pagePaths: Set<string> = new Set()\n\n  const includePatterns: string[] = []\n  const excludePatterns: string[] = []\n\n  for (const pattern of patterns) {\n    const trimmed = pattern.trim()\n    if (!trimmed) continue\n\n    if (trimmed.startsWith('!')) {\n      excludePatterns.push(escapeBrackets(trimmed.slice(1)))\n    } else {\n      includePatterns.push(escapeBrackets(trimmed))\n    }\n  }\n\n  // Default to matching all files when only negation patterns are provided.\n  if (includePatterns.length === 0 && excludePatterns.length > 0) {\n    includePatterns.push('**')\n  }\n\n  // Combine patterns using brace expansion: {pattern1,pattern2}\n  const combinedPattern =\n    includePatterns.length === 1\n      ? includePatterns[0]\n      : `{${includePatterns.join(',')}}`\n\n  try {\n    const matches = (await glob(combinedPattern, {\n      cwd: projectDir,\n      ignore: excludePatterns,\n    })) as string[]\n\n    if (matches.length === 0) {\n      Log.warn(`Pattern \"${patterns.join(',')}\" did not match any files`)\n    }\n\n    for (const file of matches) {\n      if (!fs.statSync(path.join(projectDir, file)).isDirectory()) {\n        categorizeAndAddPath(file, appPaths, pagePaths)\n      }\n    }\n  } catch (error) {\n    throw new Error(\n      `Failed to resolve pattern \"${patterns.join(',')}\": ${\n        isError(error) ? error.message : String(error)\n      }`\n    )\n  }\n\n  return {\n    appPaths: Array.from(appPaths).sort(),\n    pagePaths: Array.from(pagePaths).sort(),\n  }\n}\n\n/**\n * Categorizes a file path to either app or pages router based on its prefix.\n * For app router, only route-defining files (page.*, route.*) are included.\n *\n * Examples:\n * - \"app/page.tsx\" → appPaths.add(\"/page.tsx\")\n * - \"app/layout.tsx\" → skipped (not a route file)\n * - \"pages/index.tsx\" → pagePaths.add(\"/index.tsx\")\n */\nfunction categorizeAndAddPath(\n  filePath: string,\n  appPaths: Set<string>,\n  pagePaths: Set<string>\n): void {\n  const normalized = filePath.replace(/\\\\/g, '/')\n\n  if (normalized.startsWith('app/')) {\n    // Only include route-defining files (page.* or route.*)\n    if (/\\/(page|route)\\.[^/]+$/.test(normalized)) {\n      appPaths.add('/' + normalized.slice(4))\n    }\n  } else if (normalized.startsWith('pages/')) {\n    pagePaths.add('/' + normalized.slice(6))\n  }\n}\n\n/**\n * Parse build paths from comma-separated format\n * Supports:\n * - Comma-separated values: \"app/page.tsx,app/about/page.tsx\"\n *\n * @param input - String input to parse\n * @returns Array of path patterns\n */\nexport function parseBuildPathsInput(input: string): string[] {\n  // Comma-separated values\n  return input\n    .split(',')\n    .map((p) => p.trim())\n    .filter((p) => p.length > 0)\n}\n"],"names":["promisify","globOriginal","Log","path","fs","isError","glob","escapeBrackets","pattern","replace","match","resolveBuildPaths","patterns","projectDir","appPaths","Set","pagePaths","includePatterns","excludePatterns","trimmed","trim","startsWith","push","slice","length","combinedPattern","join","matches","cwd","ignore","warn","file","statSync","isDirectory","categorizeAndAddPath","error","Error","message","String","Array","from","sort","filePath","normalized","test","add","parseBuildPathsInput","input","split","map","p","filter"],"mappings":"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","ignoreList":[0]}