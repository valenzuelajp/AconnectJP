{"version":3,"sources":["../../../../src/shared/lib/image-loader.ts"],"sourcesContent":["import type { ImageLoaderPropsWithConfig } from './image-config'\nimport { findClosestQuality } from './find-closest-quality'\nimport { getDeploymentId } from './deployment-id'\n\nfunction defaultLoader({\n  config,\n  src,\n  width,\n  quality,\n}: ImageLoaderPropsWithConfig): string {\n  if (process.env.NODE_ENV !== 'production') {\n    const missingValues = []\n\n    // these should always be provided but make sure they are\n    if (!src) missingValues.push('src')\n    if (!width) missingValues.push('width')\n\n    if (missingValues.length > 0) {\n      throw new Error(\n        `Next Image Optimization requires ${missingValues.join(\n          ', '\n        )} to be provided. Make sure you pass them as props to the \\`next/image\\` component. Received: ${JSON.stringify(\n          { src, width, quality }\n        )}`\n      )\n    }\n  }\n\n  // Extract dpl parameter early so validation uses the clean URL\n  let deploymentId = getDeploymentId()\n  if (src.startsWith('/')) {\n    const srcUrl = new URL(src, 'http://n')\n    const srcDpl = srcUrl.searchParams.get('dpl')\n    if (srcDpl) {\n      deploymentId = srcDpl\n      // Remove the dpl parameter from the src URL to avoid duplication\n      srcUrl.searchParams.delete('dpl')\n      src = srcUrl.href.slice('http://n'.length)\n    }\n  }\n\n  if (\n    src.startsWith('/') &&\n    src.includes('?') &&\n    config.localPatterns?.length === 1 &&\n    config.localPatterns[0].pathname === '**' &&\n    config.localPatterns[0].search === ''\n  ) {\n    throw new Error(\n      `Image with src \"${src}\" is using a query string which is not configured in images.localPatterns.` +\n        `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns`\n    )\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    if (src.startsWith('//')) {\n      throw new Error(\n        `Failed to parse src \"${src}\" on \\`next/image\\`, protocol-relative URL (//) must be changed to an absolute URL (http:// or https://)`\n      )\n    }\n\n    if (src.startsWith('/') && config.localPatterns) {\n      if (\n        process.env.NODE_ENV !== 'test' &&\n        // micromatch isn't compatible with edge runtime\n        process.env.NEXT_RUNTIME !== 'edge'\n      ) {\n        // We use dynamic require because this should only error in development\n        const { hasLocalMatch } =\n          require('./match-local-pattern') as typeof import('./match-local-pattern')\n        if (!hasLocalMatch(config.localPatterns, src)) {\n          throw new Error(\n            `Invalid src prop (${src}) on \\`next/image\\` does not match \\`images.localPatterns\\` configured in your \\`next.config.js\\`\\n` +\n              `See more info: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns`\n          )\n        }\n      }\n    }\n\n    if (!src.startsWith('/') && (config.domains || config.remotePatterns)) {\n      let parsedSrc: URL\n      try {\n        parsedSrc = new URL(src)\n      } catch (err) {\n        console.error(err)\n        throw new Error(\n          `Failed to parse src \"${src}\" on \\`next/image\\`, if using relative image it must start with a leading slash \"/\" or be an absolute URL (http:// or https://)`\n        )\n      }\n\n      if (\n        process.env.NODE_ENV !== 'test' &&\n        // micromatch isn't compatible with edge runtime\n        process.env.NEXT_RUNTIME !== 'edge'\n      ) {\n        // We use dynamic require because this should only error in development\n        const { hasRemoteMatch } =\n          require('./match-remote-pattern') as typeof import('./match-remote-pattern')\n        if (\n          !hasRemoteMatch(config.domains!, config.remotePatterns!, parsedSrc)\n        ) {\n          throw new Error(\n            `Invalid src prop (${src}) on \\`next/image\\`, hostname \"${parsedSrc.hostname}\" is not configured under images in your \\`next.config.js\\`\\n` +\n              `See more info: https://nextjs.org/docs/messages/next-image-unconfigured-host`\n          )\n        }\n      }\n    }\n  }\n\n  const q = findClosestQuality(quality, config)\n\n  return `${config.path}?url=${encodeURIComponent(src)}&w=${width}&q=${q}${\n    src.startsWith('/') && deploymentId ? `&dpl=${deploymentId}` : ''\n  }`\n}\n\n// We use this to determine if the import is the default loader\n// or a custom loader defined by the user in next.config.js\ndefaultLoader.__next_img_default = true\n\nexport default defaultLoader\n"],"names":["findClosestQuality","getDeploymentId","defaultLoader","config","src","width","quality","process","env","NODE_ENV","missingValues","push","length","Error","join","JSON","stringify","deploymentId","startsWith","srcUrl","URL","srcDpl","searchParams","get","delete","href","slice","includes","localPatterns","pathname","search","NEXT_RUNTIME","hasLocalMatch","require","domains","remotePatterns","parsedSrc","err","console","error","hasRemoteMatch","hostname","q","path","encodeURIComponent","__next_img_default"],"mappings":"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","ignoreList":[0]}