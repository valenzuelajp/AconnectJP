{"version":3,"sources":["../../../../src/server/lib/router-server.ts"],"sourcesContent":["// this must come first as it includes require hooks\nimport type { WorkerRequestHandler, WorkerUpgradeHandler } from './types'\nimport type { DevBundler, ServerFields } from './router-utils/setup-dev-bundler'\nimport type { NextUrlWithParsedQuery, RequestMeta } from '../request-meta'\n\n// This is required before other imports to ensure the require hook is setup.\nimport '../node-environment'\nimport '../require-hook'\n\nimport url from 'url'\nimport path from 'path'\nimport loadConfig, { type ConfiguredExperimentalFeature } from '../config'\nimport { serveStatic } from '../serve-static'\nimport setupDebug from 'next/dist/compiled/debug'\nimport * as Log from '../../build/output/log'\nimport { DecodeError } from '../../shared/lib/utils'\nimport { findPagesDir } from '../../lib/find-pages-dir'\nimport { setupFsCheck } from './router-utils/filesystem'\nimport { proxyRequest } from './router-utils/proxy-request'\nimport { isAbortError, pipeToNodeResponse } from '../pipe-readable'\nimport { getResolveRoutes } from './router-utils/resolve-routes'\nimport { addRequestMeta, getRequestMeta } from '../request-meta'\nimport { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\nimport { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\nimport setupCompression from 'next/dist/compiled/compression'\nimport { signalFromNodeResponse } from '../web/spec-extension/adapters/next-request'\nimport { isPostpone } from './router-utils/is-postpone'\nimport { parseUrl as parseUrlUtil } from '../../shared/lib/router/utils/parse-url'\n\nimport {\n  PHASE_PRODUCTION_SERVER,\n  PHASE_DEVELOPMENT_SERVER,\n  UNDERSCORE_NOT_FOUND_ROUTE,\n} from '../../shared/lib/constants'\nimport { RedirectStatusCode } from '../../client/components/redirect-status-code'\nimport { DevBundlerService } from './dev-bundler-service'\nimport { type Span, trace } from '../../trace'\nimport { ensureLeadingSlash } from '../../shared/lib/page-path/ensure-leading-slash'\nimport { getNextPathnameInfo } from '../../shared/lib/router/utils/get-next-pathname-info'\nimport { getHostname } from '../../shared/lib/get-hostname'\nimport { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\nimport { MockedResponse } from './mock-request'\nimport {\n  HMR_MESSAGE_SENT_TO_BROWSER,\n  type AppIsrManifestMessage,\n} from '../dev/hot-reloader-types'\nimport { normalizedAssetPrefix } from '../../shared/lib/normalized-asset-prefix'\nimport { NEXT_PATCH_SYMBOL } from './patch-fetch'\nimport type { ServerInitResult } from './render-server'\nimport { filterInternalHeaders } from './server-ipc/utils'\nimport { blockCrossSite } from './router-utils/block-cross-site'\nimport { traceGlobals } from '../../trace/shared'\nimport { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\nimport {\n  RouterServerContextSymbol,\n  routerServerGlobal,\n} from './router-utils/router-server-context'\nimport {\n  handleChromeDevtoolsWorkspaceRequest,\n  isChromeDevtoolsWorkspaceUrl,\n} from './chrome-devtools-workspace'\nimport { getNextConfigRuntime, type NextConfigComplete } from '../config-shared'\n\nconst debug = setupDebug('next:router-server:main')\nconst isNextFont = (pathname: string | null) =>\n  pathname && /\\/media\\/[^/]+\\.(woff|woff2|eot|ttf|otf)$/.test(pathname)\n\nexport type RenderServer = Pick<\n  typeof import('./render-server'),\n  | 'initialize'\n  | 'clearModuleContext'\n  | 'propagateServerField'\n  | 'getServerField'\n>\n\nexport interface LazyRenderServerInstance {\n  instance?: RenderServer\n}\n\nconst requestHandlers: Record<string, WorkerRequestHandler> = {}\n\nexport async function initialize(opts: {\n  dir: string\n  port: number\n  dev: boolean\n  onDevServerCleanup: ((listener: () => Promise<void>) => void) | undefined\n  server?: import('http').Server\n  minimalMode?: boolean\n  hostname?: string\n  keepAliveTimeout?: number\n  customServer?: boolean\n  experimentalHttpsServer?: boolean\n  startServerSpan?: Span\n  quiet?: boolean\n}): Promise<ServerInitResult> {\n  if (!process.env.NODE_ENV) {\n    // @ts-ignore not readonly\n    process.env.NODE_ENV = opts.dev ? 'development' : 'production'\n  }\n\n  let experimentalFeatures: ConfiguredExperimentalFeature[] = []\n  const config = await loadConfig(\n    opts.dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_SERVER,\n    opts.dir,\n    {\n      silent: false,\n      reportExperimentalFeatures(features) {\n        experimentalFeatures = features.toSorted(({ key: a }, { key: b }) =>\n          a.localeCompare(b)\n        )\n      },\n    }\n  )\n\n  let compress: ReturnType<typeof setupCompression> | undefined\n\n  if (config?.compress !== false) {\n    compress = setupCompression()\n  }\n\n  const fsChecker = await setupFsCheck({\n    dev: opts.dev,\n    dir: opts.dir,\n    config,\n    minimalMode: opts.minimalMode,\n  })\n\n  const renderServer: LazyRenderServerInstance = {}\n\n  let development:\n    | {\n        bundler: DevBundler\n        service: DevBundlerService\n        config: NextConfigComplete\n      }\n    | undefined = undefined\n\n  let originalFetch = globalThis.fetch\n\n  if (opts.dev) {\n    const { Telemetry } =\n      require('../../telemetry/storage') as typeof import('../../telemetry/storage')\n\n    const telemetry = new Telemetry({\n      distDir: path.join(opts.dir, config.distDir),\n    })\n    traceGlobals.set('telemetry', telemetry)\n\n    const { pagesDir, appDir } = findPagesDir(opts.dir)\n\n    const { setupDevBundler } =\n      require('./router-utils/setup-dev-bundler') as typeof import('./router-utils/setup-dev-bundler')\n\n    const resetFetch = () => {\n      globalThis.fetch = originalFetch\n      ;(globalThis as Record<symbol, unknown>)[NEXT_PATCH_SYMBOL] = false\n    }\n\n    const setupDevBundlerSpan = opts.startServerSpan\n      ? opts.startServerSpan.traceChild('setup-dev-bundler')\n      : trace('setup-dev-bundler')\n\n    // In development, it's always the complete config.\n    let developmentConfig = config as NextConfigComplete\n\n    let developmentBundler = await setupDevBundlerSpan.traceAsyncFn(() =>\n      setupDevBundler({\n        // Passed here but the initialization of this object happens below, doing the initialization before the setupDev call breaks.\n        renderServer,\n        appDir,\n        pagesDir,\n        telemetry,\n        fsChecker,\n        dir: opts.dir,\n        nextConfig: developmentConfig,\n        isCustomServer: opts.customServer,\n        turbo: !!process.env.TURBOPACK,\n        port: opts.port,\n        onDevServerCleanup: opts.onDevServerCleanup,\n        resetFetch,\n      })\n    )\n\n    let devBundlerService = new DevBundlerService(\n      developmentBundler,\n      // The request handler is assigned below, this allows us to create a lazy\n      // reference to it.\n      (req, res) => {\n        return requestHandlers[opts.dir](req, res)\n      }\n    )\n\n    development = {\n      bundler: developmentBundler,\n      service: devBundlerService,\n      config: developmentConfig,\n    }\n  }\n\n  renderServer.instance =\n    require('./render-server') as typeof import('./render-server')\n\n  const requestHandlerImpl: WorkerRequestHandler = async (req, res) => {\n    addRequestMeta(req, 'relativeProjectDir', relativeProjectDir)\n\n    // internal headers should not be honored by the request handler\n    if (!process.env.NEXT_PRIVATE_TEST_HEADERS) {\n      filterInternalHeaders(req.headers)\n    }\n\n    if (\n      !opts.minimalMode &&\n      config.i18n &&\n      config.i18n.localeDetection !== false\n    ) {\n      const urlParts = (req.url || '').split('?', 1)\n      let urlNoQuery = urlParts[0] || ''\n\n      if (config.basePath) {\n        urlNoQuery = removePathPrefix(urlNoQuery, config.basePath)\n      }\n\n      const pathnameInfo = getNextPathnameInfo(urlNoQuery, {\n        nextConfig: config,\n      })\n\n      const domainLocale = detectDomainLocale(\n        config.i18n.domains,\n        getHostname({ hostname: urlNoQuery }, req.headers)\n      )\n\n      const defaultLocale =\n        domainLocale?.defaultLocale || config.i18n.defaultLocale\n\n      const { getLocaleRedirect } =\n        require('../../shared/lib/i18n/get-locale-redirect') as typeof import('../../shared/lib/i18n/get-locale-redirect')\n\n      const parsedUrl = parseUrlUtil((req.url || '')?.replace(/^\\/+/, '/'))\n\n      const redirect = getLocaleRedirect({\n        defaultLocale,\n        domainLocale,\n        headers: req.headers,\n        nextConfig: config,\n        pathLocale: pathnameInfo.locale,\n        urlParsed: {\n          ...parsedUrl,\n          pathname: pathnameInfo.locale\n            ? `/${pathnameInfo.locale}${urlNoQuery}`\n            : urlNoQuery,\n        },\n      })\n\n      if (redirect) {\n        res.setHeader('Location', redirect)\n        res.statusCode = RedirectStatusCode.TemporaryRedirect\n        res.end(redirect)\n        return\n      }\n    }\n\n    if (compress) {\n      // @ts-expect-error not express req/res\n      compress(req, res, () => {})\n    }\n    req.on('error', (_err) => {\n      // TODO: log socket errors?\n    })\n    res.on('error', (_err) => {\n      // TODO: log socket errors?\n    })\n\n    const invokedOutputs = new Set<string>()\n\n    async function invokeRender(\n      parsedUrl: NextUrlWithParsedQuery,\n      invokePath: string,\n      handleIndex: number,\n      additionalRequestMeta?: RequestMeta\n    ) {\n      // invokeRender expects /api routes to not be locale prefixed\n      // so normalize here before continuing\n      if (\n        config.i18n &&\n        removePathPrefix(invokePath, config.basePath).startsWith(\n          `/${getRequestMeta(req, 'locale')}/api`\n        )\n      ) {\n        invokePath = fsChecker.handleLocale(\n          removePathPrefix(invokePath, config.basePath)\n        ).pathname\n      }\n\n      if (\n        req.headers['x-nextjs-data'] &&\n        fsChecker.getMiddlewareMatchers()?.length &&\n        removePathPrefix(invokePath, config.basePath) === '/404'\n      ) {\n        res.setHeader('x-nextjs-matched-path', parsedUrl.pathname || '')\n        res.statusCode = 404\n        res.setHeader('content-type', 'application/json')\n        res.end('{}')\n        return null\n      }\n\n      if (!handlers) {\n        throw new Error('Failed to initialize render server')\n      }\n\n      addRequestMeta(req, 'invokePath', invokePath)\n      addRequestMeta(req, 'invokeQuery', parsedUrl.query)\n      addRequestMeta(req, 'middlewareInvoke', false)\n\n      for (const key in additionalRequestMeta || {}) {\n        addRequestMeta(\n          req,\n          key as keyof RequestMeta,\n          additionalRequestMeta![key as keyof RequestMeta]\n        )\n      }\n\n      debug('invokeRender', req.url, req.headers)\n\n      try {\n        const initResult =\n          await renderServer?.instance?.initialize(renderServerOpts)\n        try {\n          await initResult?.requestHandler(req, res)\n        } catch (err) {\n          if (err instanceof NoFallbackError) {\n            await handleRequest(handleIndex + 1)\n            return\n          }\n          throw err\n        }\n        return\n      } catch (e) {\n        // If the client aborts before we can receive a response object (when\n        // the headers are flushed), then we can early exit without further\n        // processing.\n        if (isAbortError(e)) {\n          return\n        }\n        throw e\n      }\n    }\n\n    const handleRequest = async (handleIndex: number) => {\n      if (handleIndex > 5) {\n        throw new Error(`Attempted to handle request too many times ${req.url}`)\n      }\n\n      // handle hot-reloader first\n      if (development) {\n        if (\n          blockCrossSite(\n            req,\n            res,\n            development.config.allowedDevOrigins,\n            opts.hostname\n          )\n        ) {\n          return\n        }\n\n        const origUrl = req.url || '/'\n\n        // both the basePath and assetPrefix need to be stripped from the URL\n        // so that the development bundler can find the correct file\n        if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n          req.url = removePathPrefix(origUrl, config.basePath)\n        } else if (\n          config.assetPrefix &&\n          pathHasPrefix(origUrl, config.assetPrefix)\n        ) {\n          req.url = removePathPrefix(origUrl, config.assetPrefix)\n        }\n\n        const parsedUrl = parseUrlUtil(req.url || '/')\n\n        const hotReloaderResult = await development.bundler.hotReloader.run(\n          req,\n          res,\n          parsedUrl\n        )\n\n        if (hotReloaderResult.finished) {\n          return hotReloaderResult\n        }\n\n        req.url = origUrl\n      }\n\n      const {\n        finished,\n        parsedUrl,\n        statusCode,\n        resHeaders,\n        bodyStream,\n        matchedOutput,\n      } = await resolveRoutes({\n        req,\n        res,\n        isUpgradeReq: false,\n        signal: signalFromNodeResponse(res),\n        invokedOutputs,\n      })\n\n      if (res.closed || res.finished) {\n        return\n      }\n\n      if (development && matchedOutput?.type === 'devVirtualFsItem') {\n        const origUrl = req.url || '/'\n\n        if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n          req.url = removePathPrefix(origUrl, config.basePath)\n        } else if (\n          config.assetPrefix &&\n          pathHasPrefix(origUrl, config.assetPrefix)\n        ) {\n          req.url = removePathPrefix(origUrl, config.assetPrefix)\n        }\n\n        if (resHeaders !== null) {\n          for (const key of Object.keys(resHeaders)) {\n            res.setHeader(key, resHeaders[key])\n          }\n        }\n        const result = await development.bundler.requestHandler(req, res)\n\n        if (result.finished) {\n          return\n        }\n        // TODO: throw invariant if we resolved to this but it wasn't handled?\n        req.url = origUrl\n      }\n\n      debug('requestHandler!', req.url, {\n        matchedOutput,\n        statusCode,\n        resHeaders,\n        bodyStream: !!bodyStream,\n        parsedUrl: {\n          pathname: parsedUrl.pathname,\n          query: parsedUrl.query,\n        },\n        finished,\n      })\n\n      // apply any response headers from routing\n      if (resHeaders !== null) {\n        for (const key of Object.keys(resHeaders)) {\n          res.setHeader(key, resHeaders[key])\n        }\n      }\n\n      // handle redirect\n      if (!bodyStream && statusCode && statusCode > 300 && statusCode < 400) {\n        const destination = url.format(parsedUrl)\n        res.statusCode = statusCode\n        res.setHeader('location', destination)\n\n        if (statusCode === RedirectStatusCode.PermanentRedirect) {\n          res.setHeader('Refresh', `0;url=${destination}`)\n        }\n        return res.end(destination)\n      }\n\n      // handle middleware body response\n      if (bodyStream) {\n        res.statusCode = statusCode || 200\n        return await pipeToNodeResponse(bodyStream, res)\n      }\n\n      if (finished && parsedUrl.protocol) {\n        return await proxyRequest(\n          req,\n          res,\n          parsedUrl,\n          undefined,\n          getRequestMeta(req, 'clonableBody')?.cloneBodyStream(),\n          config.experimental.proxyTimeout\n        )\n      }\n\n      if (matchedOutput?.fsPath && matchedOutput.itemPath) {\n        if (\n          opts.dev &&\n          (fsChecker.appFiles.has(matchedOutput.itemPath) ||\n            fsChecker.pageFiles.has(matchedOutput.itemPath))\n        ) {\n          res.statusCode = 500\n          const message = `A conflicting public file and page file was found for path ${matchedOutput.itemPath} https://nextjs.org/docs/messages/conflicting-public-file-page`\n          await invokeRender(parsedUrl, '/_error', handleIndex, {\n            invokeStatus: 500,\n            invokeError: new Error(message),\n          })\n          Log.error(message)\n          return\n        }\n\n        if (\n          !res.getHeader('cache-control') &&\n          matchedOutput.type === 'nextStaticFolder'\n        ) {\n          if (opts.dev && !isNextFont(parsedUrl.pathname)) {\n            res.setHeader(\n              'Cache-Control',\n              config.experimental.devCacheControlNoCache\n                ? 'no-cache, must-revalidate'\n                : 'no-store, must-revalidate'\n            )\n          } else {\n            res.setHeader(\n              'Cache-Control',\n              'public, max-age=31536000, immutable'\n            )\n          }\n        }\n        if (!(req.method === 'GET' || req.method === 'HEAD')) {\n          res.setHeader('Allow', ['GET', 'HEAD'])\n          res.statusCode = 405\n          return await invokeRender(parseUrlUtil('/405'), '/405', handleIndex, {\n            invokeStatus: 405,\n          })\n        }\n\n        try {\n          return await serveStatic(req, res, matchedOutput.itemPath, {\n            root: matchedOutput.itemsRoot,\n            // Ensures that etags are not generated for static files when disabled.\n            etag: config.generateEtags,\n          })\n        } catch (err: any) {\n          /**\n           * Hardcoded every possible error status code that could be thrown by \"serveStatic\" method\n           * This is done by searching \"this.error\" inside \"send\" module's source code:\n           * https://github.com/pillarjs/send/blob/master/index.js\n           * https://github.com/pillarjs/send/blob/develop/index.js\n           */\n          const POSSIBLE_ERROR_CODE_FROM_SERVE_STATIC = new Set([\n            // send module will throw 500 when header is already sent or fs.stat error happens\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L392\n            // Note: we will use Next.js built-in 500 page to handle 500 errors\n            // 500,\n\n            // send module will throw 404 when file is missing\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L421\n            // Note: we will use Next.js built-in 404 page to handle 404 errors\n            // 404,\n\n            // send module will throw 403 when redirecting to a directory without enabling directory listing\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L484\n            // Note: Next.js throws a different error (without status code) for directory listing\n            // 403,\n\n            // send module will throw 400 when fails to normalize the path\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L520\n            400,\n\n            // send module will throw 412 with conditional GET request\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L632\n            412,\n\n            // send module will throw 416 when range is not satisfiable\n            // https://github.com/pillarjs/send/blob/53f0ab476145670a9bdd3dc722ab2fdc8d358fc6/index.js#L669\n            416,\n          ])\n\n          let validErrorStatus = POSSIBLE_ERROR_CODE_FROM_SERVE_STATIC.has(\n            err.statusCode\n          )\n\n          // normalize non-allowed status codes\n          if (!validErrorStatus) {\n            ;(err as any).statusCode = 400\n          }\n\n          if (typeof err.statusCode === 'number') {\n            const invokePath = `/${err.statusCode}`\n            const invokeStatus = err.statusCode\n            res.statusCode = err.statusCode\n            return await invokeRender(\n              parseUrlUtil(invokePath),\n              invokePath,\n              handleIndex,\n              {\n                invokeStatus,\n              }\n            )\n          }\n          throw err\n        }\n      }\n\n      if (matchedOutput) {\n        invokedOutputs.add(matchedOutput.itemPath)\n\n        return await invokeRender(\n          parsedUrl,\n          parsedUrl.pathname || '/',\n          handleIndex,\n          {\n            invokeOutput: matchedOutput.itemPath,\n          }\n        )\n      }\n\n      // We want the original pathname without any basePath or proxy rewrites.\n      if (development && isChromeDevtoolsWorkspaceUrl(req.url)) {\n        await handleChromeDevtoolsWorkspaceRequest(res, opts, config)\n        return\n      }\n\n      // 404 case\n      res.setHeader(\n        'Cache-Control',\n        'private, no-cache, no-store, max-age=0, must-revalidate'\n      )\n\n      let realRequestPathname = parsedUrl.pathname ?? ''\n      if (realRequestPathname) {\n        if (config.basePath) {\n          realRequestPathname = removePathPrefix(\n            realRequestPathname,\n            config.basePath\n          )\n        }\n        if (config.assetPrefix) {\n          realRequestPathname = removePathPrefix(\n            realRequestPathname,\n            config.assetPrefix\n          )\n        }\n        if (config.i18n) {\n          realRequestPathname = removePathPrefix(\n            realRequestPathname,\n            '/' + (getRequestMeta(req, 'locale') ?? '')\n          )\n        }\n      }\n      // For not found static assets, return plain text 404 instead of\n      // full HTML 404 pages to save bandwidth.\n      if (realRequestPathname.startsWith('/_next/static/')) {\n        res.statusCode = 404\n        res.setHeader('Content-Type', 'text/plain; charset=utf-8')\n        res.end('Not Found')\n        return null\n      }\n\n      // Short-circuit favicon.ico serving so that the 404 page doesn't get built as favicon is requested by the browser when loading any route.\n      if (opts.dev && !matchedOutput && parsedUrl.pathname === '/favicon.ico') {\n        res.statusCode = 404\n        res.end('')\n        return null\n      }\n\n      const appNotFound = opts.dev\n        ? development?.bundler?.serverFields.hasAppNotFound\n        : await fsChecker.getItem(UNDERSCORE_NOT_FOUND_ROUTE)\n\n      res.statusCode = 404\n\n      if (appNotFound) {\n        return await invokeRender(\n          parsedUrl,\n          UNDERSCORE_NOT_FOUND_ROUTE,\n          handleIndex,\n          {\n            invokeStatus: 404,\n          }\n        )\n      }\n\n      await invokeRender(parsedUrl, '/404', handleIndex, {\n        invokeStatus: 404,\n      })\n    }\n\n    try {\n      await handleRequest(0)\n    } catch (err) {\n      try {\n        let invokePath = '/500'\n        let invokeStatus = '500'\n\n        if (err instanceof DecodeError) {\n          invokePath = '/400'\n          invokeStatus = '400'\n        } else {\n          console.error(err)\n        }\n        res.statusCode = Number(invokeStatus)\n        return await invokeRender(parseUrlUtil(invokePath), invokePath, 0, {\n          invokeStatus: res.statusCode,\n        })\n      } catch (err2) {\n        console.error(err2)\n      }\n      res.statusCode = 500\n      res.end('Internal Server Error')\n    }\n  }\n\n  let requestHandler: WorkerRequestHandler = requestHandlerImpl\n  if (config.experimental.testProxy) {\n    // Intercept fetch and other testmode apis.\n    const { wrapRequestHandlerWorker, interceptTestApis } =\n      // eslint-disable-next-line @next/internal/typechecked-require -- experimental/testmode is not built ins next/dist/esm\n      require('next/dist/experimental/testmode/server') as typeof import('../../experimental/testmode/server')\n    requestHandler = wrapRequestHandlerWorker(requestHandler)\n    interceptTestApis()\n    // We treat the intercepted fetch as \"original\" fetch that should be reset to during HMR.\n    originalFetch = globalThis.fetch\n  }\n  requestHandlers[opts.dir] = requestHandler\n\n  const renderServerOpts: Parameters<RenderServer['initialize']>[0] = {\n    port: opts.port,\n    dir: opts.dir,\n    hostname: opts.hostname,\n    minimalMode: opts.minimalMode,\n    dev: !!opts.dev,\n    server: opts.server,\n    serverFields: {\n      ...(development?.bundler?.serverFields || {}),\n      setIsrStatus: development?.service?.setIsrStatus.bind(\n        development?.service\n      ),\n    } satisfies ServerFields,\n    experimentalTestProxy: !!config.experimental.testProxy,\n    experimentalHttpsServer: !!opts.experimentalHttpsServer,\n    bundlerService: development?.service,\n    startServerSpan: opts.startServerSpan,\n    quiet: opts.quiet,\n    onDevServerCleanup: opts.onDevServerCleanup,\n    distDir: config.distDir,\n    experimentalFeatures,\n    cacheComponents: config.cacheComponents,\n  }\n  renderServerOpts.serverFields.routerServerHandler = requestHandlerImpl\n\n  // pre-initialize workers\n  const handlers = await renderServer.instance.initialize(renderServerOpts)\n\n  // this must come after initialize of render server since it's\n  // using initialized methods\n  if (!routerServerGlobal[RouterServerContextSymbol]) {\n    routerServerGlobal[RouterServerContextSymbol] = {}\n  }\n  const relativeProjectDir = path.relative(process.cwd(), opts.dir)\n\n  routerServerGlobal[RouterServerContextSymbol][relativeProjectDir] = {\n    nextConfig: getNextConfigRuntime(config),\n    hostname: handlers.server.hostname,\n    revalidate: handlers.server.revalidate.bind(handlers.server),\n    render404: handlers.server.render404.bind(handlers.server),\n    experimentalTestProxy: renderServerOpts.experimentalTestProxy,\n    logErrorWithOriginalStack: opts.dev\n      ? handlers.server.logErrorWithOriginalStack.bind(handlers.server)\n      : (err: unknown) => !opts.quiet && Log.error(err),\n    setCacheStatus: config.cacheComponents\n      ? development?.service?.setCacheStatus.bind(development?.service)\n      : undefined,\n    setIsrStatus: development?.service?.setIsrStatus.bind(development?.service),\n    setReactDebugChannel: development?.config.experimental.reactDebugChannel\n      ? development?.service?.setReactDebugChannel.bind(development?.service)\n      : undefined,\n    sendErrorsToBrowser: development?.service?.sendErrorsToBrowser.bind(\n      development?.service\n    ),\n  }\n\n  const logError = async (\n    type: 'uncaughtException' | 'unhandledRejection',\n    err: Error | undefined\n  ) => {\n    if (isPostpone(err)) {\n      // React postpones that are unhandled might end up logged here but they're\n      // not really errors. They're just part of rendering.\n      return\n    }\n    if (type === 'unhandledRejection') {\n      Log.error('unhandledRejection: ', err)\n    } else if (type === 'uncaughtException') {\n      Log.error('uncaughtException: ', err)\n    }\n  }\n\n  process.on('uncaughtException', logError.bind(null, 'uncaughtException'))\n  process.on('unhandledRejection', logError.bind(null, 'unhandledRejection'))\n\n  const resolveRoutes = getResolveRoutes(\n    fsChecker,\n    config,\n    opts,\n    renderServer.instance,\n    renderServerOpts,\n    development?.bundler?.ensureMiddleware\n  )\n\n  const upgradeHandler: WorkerUpgradeHandler = async (req, socket, head) => {\n    try {\n      req.on('error', (_err) => {\n        // TODO: log socket errors?\n        // console.error(_err);\n      })\n      socket.on('error', (_err) => {\n        // TODO: log socket errors?\n        // console.error(_err);\n      })\n\n      if (opts.dev && development && req.url) {\n        if (\n          blockCrossSite(\n            req,\n            socket,\n            development.config.allowedDevOrigins,\n            opts.hostname\n          )\n        ) {\n          return\n        }\n        const { basePath, assetPrefix } = config\n\n        let hmrPrefix = basePath\n\n        // assetPrefix overrides basePath for HMR path\n        if (assetPrefix) {\n          hmrPrefix = normalizedAssetPrefix(assetPrefix)\n\n          if (URL.canParse(hmrPrefix)) {\n            // remove trailing slash from pathname\n            // return empty string if pathname is '/'\n            // to avoid conflicts with '/_next' below\n            hmrPrefix = new URL(hmrPrefix).pathname.replace(/\\/$/, '')\n          }\n        }\n\n        const isHMRRequest = req.url.startsWith(\n          ensureLeadingSlash(`${hmrPrefix}/_next/webpack-hmr`)\n        )\n\n        // only handle HMR requests if the basePath in the request\n        // matches the basePath for the handler responding to the request\n        if (isHMRRequest) {\n          return development.bundler.hotReloader.onHMR(\n            req,\n            socket,\n            head,\n            (client, { isLegacyClient }) => {\n              if (isLegacyClient) {\n                // Only send the ISR manifest to legacy clients, i.e. Pages\n                // Router clients, or App Router clients that have Cache\n                // Components disabled. The ISR manifest is only used to inform\n                // the static indicator, which currently does not provide useful\n                // information if Cache Components is enabled due to its binary\n                // nature (i.e. it does not support showing info for partially\n                // static pages).\n                client.send(\n                  JSON.stringify({\n                    type: HMR_MESSAGE_SENT_TO_BROWSER.ISR_MANIFEST,\n                    data: development.service?.appIsrManifest || {},\n                  } satisfies AppIsrManifestMessage)\n                )\n              }\n            }\n          )\n        }\n      }\n\n      const res = new MockedResponse({\n        resWriter: () => {\n          throw new Error(\n            'Invariant: did not expect response writer to be written to for upgrade request'\n          )\n        },\n      })\n      const { matchedOutput, parsedUrl } = await resolveRoutes({\n        req,\n        res,\n        isUpgradeReq: true,\n        signal: signalFromNodeResponse(socket),\n      })\n\n      // TODO: allow upgrade requests to pages/app paths?\n      // this was not previously supported\n      if (matchedOutput) {\n        return socket.end()\n      }\n\n      if (parsedUrl.protocol) {\n        return await proxyRequest(req, socket, parsedUrl, head)\n      }\n\n      // If there's no matched output, we don't handle the request as user's\n      // custom WS server may be listening on the same path.\n    } catch (err) {\n      console.error('Error handling upgrade request', err)\n      socket.end()\n    }\n  }\n\n  return {\n    requestHandler,\n    upgradeHandler,\n    server: handlers.server,\n    closeUpgraded() {\n      development?.bundler?.hotReloader?.close()\n    },\n    distDir: config.distDir,\n    experimentalFeatures,\n    cacheComponents: config.cacheComponents,\n  }\n}\n"],"names":["url","path","loadConfig","serveStatic","setupDebug","Log","DecodeError","findPagesDir","setupFsCheck","proxyRequest","isAbortError","pipeToNodeResponse","getResolveRoutes","addRequestMeta","getRequestMeta","pathHasPrefix","removePathPrefix","setupCompression","signalFromNodeResponse","isPostpone","parseUrl","parseUrlUtil","PHASE_PRODUCTION_SERVER","PHASE_DEVELOPMENT_SERVER","UNDERSCORE_NOT_FOUND_ROUTE","RedirectStatusCode","DevBundlerService","trace","ensureLeadingSlash","getNextPathnameInfo","getHostname","detectDomainLocale","MockedResponse","HMR_MESSAGE_SENT_TO_BROWSER","normalizedAssetPrefix","NEXT_PATCH_SYMBOL","filterInternalHeaders","blockCrossSite","traceGlobals","NoFallbackError","RouterServerContextSymbol","routerServerGlobal","handleChromeDevtoolsWorkspaceRequest","isChromeDevtoolsWorkspaceUrl","getNextConfigRuntime","debug","isNextFont","pathname","test","requestHandlers","initialize","opts","development","process","env","NODE_ENV","dev","experimentalFeatures","config","dir","silent","reportExperimentalFeatures","features","toSorted","key","a","b","localeCompare","compress","fsChecker","minimalMode","renderServer","undefined","originalFetch","globalThis","fetch","Telemetry","require","telemetry","distDir","join","set","pagesDir","appDir","setupDevBundler","resetFetch","setupDevBundlerSpan","startServerSpan","traceChild","developmentConfig","developmentBundler","traceAsyncFn","nextConfig","isCustomServer","customServer","turbo","TURBOPACK","port","onDevServerCleanup","devBundlerService","req","res","bundler","service","instance","requestHandlerImpl","relativeProjectDir","NEXT_PRIVATE_TEST_HEADERS","headers","i18n","localeDetection","urlParts","split","urlNoQuery","basePath","pathnameInfo","domainLocale","domains","hostname","defaultLocale","getLocaleRedirect","parsedUrl","replace","redirect","pathLocale","locale","urlParsed","setHeader","statusCode","TemporaryRedirect","end","on","_err","invokedOutputs","Set","invokeRender","invokePath","handleIndex","additionalRequestMeta","startsWith","handleLocale","getMiddlewareMatchers","length","handlers","Error","query","initResult","renderServerOpts","requestHandler","err","handleRequest","e","allowedDevOrigins","origUrl","assetPrefix","hotReloaderResult","hotReloader","run","finished","resHeaders","bodyStream","matchedOutput","resolveRoutes","isUpgradeReq","signal","closed","type","Object","keys","result","destination","format","PermanentRedirect","protocol","cloneBodyStream","experimental","proxyTimeout","fsPath","itemPath","appFiles","has","pageFiles","message","invokeStatus","invokeError","error","getHeader","devCacheControlNoCache","method","root","itemsRoot","etag","generateEtags","POSSIBLE_ERROR_CODE_FROM_SERVE_STATIC","validErrorStatus","add","invokeOutput","realRequestPathname","appNotFound","serverFields","hasAppNotFound","getItem","console","Number","err2","testProxy","wrapRequestHandlerWorker","interceptTestApis","server","setIsrStatus","bind","experimentalTestProxy","experimentalHttpsServer","bundlerService","quiet","cacheComponents","routerServerHandler","relative","cwd","revalidate","render404","logErrorWithOriginalStack","setCacheStatus","setReactDebugChannel","reactDebugChannel","sendErrorsToBrowser","logError","ensureMiddleware","upgradeHandler","socket","head","hmrPrefix","URL","canParse","isHMRRequest","onHMR","client","isLegacyClient","send","JSON","stringify","ISR_MANIFEST","data","appIsrManifest","resWriter","closeUpgraded","close"],"mappings":"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","ignoreList":[0]}