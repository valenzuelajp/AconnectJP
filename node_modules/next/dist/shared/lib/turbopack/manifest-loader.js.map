{"version":3,"sources":["../../../../src/shared/lib/turbopack/manifest-loader.ts"],"sourcesContent":["import type {\n  EdgeFunctionDefinition,\n  MiddlewareManifest,\n} from '../../../build/webpack/plugins/middleware-plugin'\nimport type {\n  StatsAsset,\n  StatsChunk,\n  StatsChunkGroup,\n  StatsModule,\n  StatsCompilation as WebpackStats,\n} from 'webpack'\nimport type { BuildManifest } from '../../../server/get-page-files'\nimport type { PagesManifest } from '../../../build/webpack/plugins/pages-manifest-plugin'\nimport type { ActionManifest } from '../../../build/webpack/plugins/flight-client-entry-plugin'\nimport type { NextFontManifest } from '../../../build/webpack/plugins/next-font-manifest-plugin'\nimport type { REACT_LOADABLE_MANIFEST } from '../constants'\nimport {\n  APP_PATHS_MANIFEST,\n  BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  INTERCEPTION_ROUTE_REWRITE_MANIFEST,\n  MIDDLEWARE_BUILD_MANIFEST,\n  MIDDLEWARE_MANIFEST,\n  NEXT_FONT_MANIFEST,\n  PAGES_MANIFEST,\n  SERVER_REFERENCE_MANIFEST,\n  TURBOPACK_CLIENT_BUILD_MANIFEST,\n  TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n  WEBPACK_STATS,\n} from '../constants'\nimport { join, posix } from 'path'\nimport { readFileSync } from 'fs'\nimport type { SetupOpts } from '../../../server/lib/router-utils/setup-dev-bundler'\nimport { deleteCache } from '../../../server/dev/require-cache'\nimport { writeFileAtomic } from '../../../lib/fs/write-atomic'\nimport { isInterceptionRouteRewrite } from '../../../lib/generate-interception-routes-rewrites'\nimport getAssetPathFromRoute from '../router/utils/get-asset-path-from-route'\nimport { getEntryKey, type EntryKey } from './entry-key'\nimport type { CustomRoutes } from '../../../lib/load-custom-routes'\nimport { getSortedRoutes } from '../router/utils'\nimport { existsSync } from 'fs'\nimport {\n  addMetadataIdToRoute,\n  addRouteSuffix,\n  removeRouteSuffix,\n} from '../../../server/dev/turbopack-utils'\nimport { tryToParsePath } from '../../../lib/try-to-parse-path'\nimport { safePathToRegexp } from '../router/utils/route-match-utils'\nimport type { Entrypoints } from '../../../build/swc/types'\nimport {\n  normalizeRewritesForBuildManifest,\n  type ClientBuildManifest,\n  srcEmptySsgManifest,\n  processRoute,\n  createEdgeRuntimeManifest,\n} from '../../../build/webpack/plugins/build-manifest-plugin-utils'\n\ninterface InstrumentationDefinition {\n  files: string[]\n  name: 'instrumentation'\n}\n\ntype TurbopackMiddlewareManifest = MiddlewareManifest & {\n  instrumentation?: InstrumentationDefinition\n}\n\ntype ManifestName =\n  | typeof MIDDLEWARE_MANIFEST\n  | typeof BUILD_MANIFEST\n  | typeof PAGES_MANIFEST\n  | typeof WEBPACK_STATS\n  | typeof APP_PATHS_MANIFEST\n  | `${typeof SERVER_REFERENCE_MANIFEST}.json`\n  | `${typeof NEXT_FONT_MANIFEST}.json`\n  | typeof REACT_LOADABLE_MANIFEST\n  | typeof TURBOPACK_CLIENT_BUILD_MANIFEST\n\nconst getManifestPath = (\n  page: string,\n  distDir: string,\n  name: ManifestName,\n  type: string,\n  firstCall: boolean\n) => {\n  let manifestPath = posix.join(\n    distDir,\n    `server`,\n    type,\n    type === 'middleware' || type === 'instrumentation'\n      ? ''\n      : type === 'app'\n        ? page\n        : getAssetPathFromRoute(page),\n    name\n  )\n\n  if (firstCall) {\n    const isSitemapRoute = /[\\\\/]sitemap(.xml)?\\/route$/.test(page)\n    // Check the ambiguity of /sitemap and /sitemap.xml\n    if (isSitemapRoute && !existsSync(manifestPath)) {\n      manifestPath = getManifestPath(\n        page.replace(/\\/sitemap\\/route$/, '/sitemap.xml/route'),\n        distDir,\n        name,\n        type,\n        false\n      )\n    }\n    // existsSync is faster than using the async version\n    if (!existsSync(manifestPath) && page.endsWith('/route')) {\n      // TODO: Improve implementation of metadata routes, currently it requires this extra check for the variants of the files that can be written.\n      let metadataPage = addRouteSuffix(\n        addMetadataIdToRoute(removeRouteSuffix(page))\n      )\n      manifestPath = getManifestPath(metadataPage, distDir, name, type, false)\n    }\n  }\n\n  return manifestPath\n}\n\nfunction readPartialManifestContent(\n  distDir: string,\n  name: ManifestName,\n  pageName: string,\n  type: 'pages' | 'app' | 'middleware' | 'instrumentation' = 'pages'\n): string {\n  const page = pageName\n  const manifestPath = getManifestPath(page, distDir, name, type, true)\n  return readFileSync(posix.join(manifestPath), 'utf-8')\n}\n\n/// Helper class that stores a map of manifests and tracks if they have changed\n/// since the last time they were written to disk. This is used to avoid\n/// unnecessary writes to disk.\nclass ManifestsMap<K, V> {\n  private rawMap = new Map<K, string>()\n  private map = new Map<K, V>()\n  private extraInvalidationKey: string | undefined = undefined\n  private changed = true\n\n  set(key: K, value: string) {\n    if (this.rawMap.get(key) === value) return\n    this.changed = true\n    this.rawMap.set(key, value)\n    this.map.set(key, JSON.parse(value))\n  }\n\n  delete(key: K) {\n    if (this.map.has(key)) {\n      this.changed = true\n      this.rawMap.delete(key)\n      this.map.delete(key)\n    }\n  }\n\n  get(key: K) {\n    return this.map.get(key)\n  }\n\n  takeChanged(extraInvalidationKey?: any) {\n    let changed = this.changed\n    if (extraInvalidationKey !== undefined) {\n      const stringified = JSON.stringify(extraInvalidationKey)\n      if (this.extraInvalidationKey !== stringified) {\n        this.extraInvalidationKey = stringified\n        changed = true\n      }\n    }\n    this.changed = false\n    return changed\n  }\n\n  values() {\n    return this.map.values()\n  }\n}\n\nexport class TurbopackManifestLoader {\n  private actionManifests: ManifestsMap<EntryKey, ActionManifest> =\n    new ManifestsMap()\n  private appPathsManifests: ManifestsMap<EntryKey, PagesManifest> =\n    new ManifestsMap()\n  private buildManifests: ManifestsMap<EntryKey, BuildManifest> =\n    new ManifestsMap()\n  private clientBuildManifests: ManifestsMap<EntryKey, ClientBuildManifest> =\n    new ManifestsMap()\n  private fontManifests: ManifestsMap<EntryKey, NextFontManifest> =\n    new ManifestsMap()\n  private middlewareManifests: ManifestsMap<\n    EntryKey,\n    TurbopackMiddlewareManifest\n  > = new ManifestsMap()\n  private pagesManifests: ManifestsMap<string, PagesManifest> =\n    new ManifestsMap()\n  private webpackStats: ManifestsMap<EntryKey, WebpackStats> =\n    new ManifestsMap()\n  private encryptionKey: string\n  /// interceptionRewrites that have been written to disk\n  /// This is used to avoid unnecessary writes if the rewrites haven't changed\n  private cachedInterceptionRewrites: string | undefined = undefined\n\n  private readonly distDir: string\n  private readonly buildId: string\n  private readonly deploymentId: string\n  private readonly dev: boolean\n\n  constructor({\n    distDir,\n    buildId,\n    encryptionKey,\n    dev,\n    deploymentId,\n  }: {\n    buildId: string\n    distDir: string\n    encryptionKey: string\n    dev: boolean\n    deploymentId: string\n  }) {\n    this.distDir = distDir\n    this.buildId = buildId\n    this.encryptionKey = encryptionKey\n    this.dev = dev\n    this.deploymentId = deploymentId\n  }\n\n  delete(key: EntryKey) {\n    this.actionManifests.delete(key)\n    this.appPathsManifests.delete(key)\n    this.buildManifests.delete(key)\n    this.clientBuildManifests.delete(key)\n    this.fontManifests.delete(key)\n    this.middlewareManifests.delete(key)\n    this.pagesManifests.delete(key)\n    this.webpackStats.delete(key)\n  }\n\n  loadActionManifest(pageName: string): void {\n    this.actionManifests.set(\n      getEntryKey('app', 'server', pageName),\n      readPartialManifestContent(\n        this.distDir,\n        `${SERVER_REFERENCE_MANIFEST}.json`,\n        pageName,\n        'app'\n      )\n    )\n  }\n\n  private mergeActionManifests(manifests: Iterable<ActionManifest>) {\n    type ActionEntries = ActionManifest['edge' | 'node']\n    const manifest: ActionManifest = {\n      node: {},\n      edge: {},\n      encryptionKey: this.encryptionKey,\n    }\n\n    function mergeActionIds(\n      actionEntries: ActionEntries,\n      other: ActionEntries\n    ): void {\n      for (const key in other) {\n        const action = (actionEntries[key] ??= {\n          workers: {},\n          layer: {},\n        })\n        action.filename = other[key].filename\n        action.exportedName = other[key].exportedName\n        Object.assign(action.workers, other[key].workers)\n        Object.assign(action.layer, other[key].layer)\n      }\n    }\n\n    for (const m of manifests) {\n      mergeActionIds(manifest.node, m.node)\n      mergeActionIds(manifest.edge, m.edge)\n    }\n    for (const key in manifest.node) {\n      const entry = manifest.node[key]\n      entry.workers = sortObjectByKey(entry.workers)\n      entry.layer = sortObjectByKey(entry.layer)\n    }\n    for (const key in manifest.edge) {\n      const entry = manifest.edge[key]\n      entry.workers = sortObjectByKey(entry.workers)\n      entry.layer = sortObjectByKey(entry.layer)\n    }\n\n    return manifest\n  }\n\n  private writeActionManifest(): void {\n    if (!this.actionManifests.takeChanged()) {\n      return\n    }\n    const actionManifest = this.mergeActionManifests(\n      this.actionManifests.values()\n    )\n    const actionManifestJsonPath = join(\n      this.distDir,\n      'server',\n      `${SERVER_REFERENCE_MANIFEST}.json`\n    )\n    const actionManifestJsPath = join(\n      this.distDir,\n      'server',\n      `${SERVER_REFERENCE_MANIFEST}.js`\n    )\n    const json = JSON.stringify(actionManifest, null, 2)\n    deleteCache(actionManifestJsonPath)\n    deleteCache(actionManifestJsPath)\n    writeFileAtomic(actionManifestJsonPath, json)\n    writeFileAtomic(\n      actionManifestJsPath,\n      `self.__RSC_SERVER_MANIFEST=${JSON.stringify(json)}`\n    )\n  }\n\n  loadAppPathsManifest(pageName: string): void {\n    this.appPathsManifests.set(\n      getEntryKey('app', 'server', pageName),\n      readPartialManifestContent(\n        this.distDir,\n        APP_PATHS_MANIFEST,\n        pageName,\n        'app'\n      )\n    )\n  }\n\n  private writeAppPathsManifest(): void {\n    if (!this.appPathsManifests.takeChanged()) {\n      return\n    }\n    const appPathsManifest = this.mergePagesManifests(\n      this.appPathsManifests.values()\n    )\n    const appPathsManifestPath = join(\n      this.distDir,\n      'server',\n      APP_PATHS_MANIFEST\n    )\n    deleteCache(appPathsManifestPath)\n    writeFileAtomic(\n      appPathsManifestPath,\n      JSON.stringify(appPathsManifest, null, 2)\n    )\n  }\n\n  private writeWebpackStats(): void {\n    if (!this.webpackStats.takeChanged()) {\n      return\n    }\n    const webpackStats = this.mergeWebpackStats(this.webpackStats.values())\n    const path = join(this.distDir, 'server', WEBPACK_STATS)\n    deleteCache(path)\n    writeFileAtomic(path, JSON.stringify(webpackStats, null, 2))\n  }\n\n  loadBuildManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n    this.buildManifests.set(\n      getEntryKey(type, 'server', pageName),\n      readPartialManifestContent(this.distDir, BUILD_MANIFEST, pageName, type)\n    )\n  }\n\n  loadClientBuildManifest(\n    pageName: string,\n    type: 'app' | 'pages' = 'pages'\n  ): void {\n    this.clientBuildManifests.set(\n      getEntryKey(type, 'server', pageName),\n      readPartialManifestContent(\n        this.distDir,\n        TURBOPACK_CLIENT_BUILD_MANIFEST,\n        pageName,\n        type\n      )\n    )\n  }\n\n  loadWebpackStats(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n    this.webpackStats.set(\n      getEntryKey(type, 'client', pageName),\n      readPartialManifestContent(this.distDir, WEBPACK_STATS, pageName, type)\n    )\n  }\n\n  private mergeWebpackStats(statsFiles: Iterable<WebpackStats>): WebpackStats {\n    const entrypoints: Record<string, StatsChunkGroup> = {}\n    const assets: Map<string, StatsAsset> = new Map()\n    const chunks: Map<string | number, StatsChunk> = new Map()\n    const modules: Map<string | number, StatsModule> = new Map()\n\n    for (const statsFile of statsFiles) {\n      if (statsFile.entrypoints) {\n        for (const [k, v] of Object.entries(statsFile.entrypoints)) {\n          if (!entrypoints[k]) {\n            entrypoints[k] = v\n          }\n        }\n      }\n\n      if (statsFile.assets) {\n        for (const asset of statsFile.assets) {\n          if (!assets.has(asset.name)) {\n            assets.set(asset.name, asset)\n          }\n        }\n      }\n\n      if (statsFile.chunks) {\n        for (const chunk of statsFile.chunks) {\n          if (!chunks.has(chunk.id!)) {\n            chunks.set(chunk.id!, chunk)\n          }\n        }\n      }\n\n      if (statsFile.modules) {\n        for (const module of statsFile.modules) {\n          const id = module.id\n          if (id != null) {\n            // Merge the chunk list for the module. This can vary across endpoints.\n            const existing = modules.get(id)\n            if (existing == null) {\n              modules.set(id, module)\n            } else if (module.chunks != null && existing.chunks != null) {\n              for (const chunk of module.chunks) {\n                if (!existing.chunks.includes(chunk)) {\n                  existing.chunks.push(chunk)\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return {\n      version: 'Turbopack',\n      entrypoints,\n      assets: [...assets.values()],\n      chunks: [...chunks.values()],\n      modules: [...modules.values()],\n    }\n  }\n\n  private mergeBuildManifests(\n    manifests: Iterable<BuildManifest>,\n    lowPriorityFiles: string[]\n  ) {\n    const manifest: Partial<BuildManifest> & Pick<BuildManifest, 'pages'> = {\n      pages: {\n        '/_app': [],\n      },\n      // Something in next.js depends on these to exist even for app dir rendering\n      devFiles: [],\n      polyfillFiles: [],\n      lowPriorityFiles,\n      rootMainFiles: [],\n    }\n    for (const m of manifests) {\n      Object.assign(manifest.pages, m.pages)\n      if (m.rootMainFiles.length) manifest.rootMainFiles = m.rootMainFiles\n      // polyfillFiles should always be the same, so we can overwrite instead of actually merging\n      if (m.polyfillFiles.length) manifest.polyfillFiles = m.polyfillFiles\n    }\n    manifest.pages = sortObjectByKey(manifest.pages) as BuildManifest['pages']\n    return manifest\n  }\n\n  private mergeClientBuildManifests(\n    manifests: Iterable<ClientBuildManifest>,\n    rewrites: CustomRoutes['rewrites'],\n    sortedPageKeys: string[]\n  ): ClientBuildManifest {\n    const manifest = {\n      __rewrites: rewrites as any,\n      sortedPages: sortedPageKeys,\n    }\n    for (const m of manifests) {\n      Object.assign(manifest, m)\n    }\n    return sortObjectByKey(manifest)\n  }\n\n  private writeInterceptionRouteRewriteManifest(\n    devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n    productionRewrites: CustomRoutes['rewrites'] | undefined\n  ): void {\n    const rewrites = productionRewrites ?? {\n      ...devRewrites,\n      beforeFiles: (devRewrites?.beforeFiles ?? []).map(processRoute),\n      afterFiles: (devRewrites?.afterFiles ?? []).map(processRoute),\n      fallback: (devRewrites?.fallback ?? []).map(processRoute),\n    }\n\n    const interceptionRewrites = JSON.stringify(\n      rewrites.beforeFiles.filter(isInterceptionRouteRewrite)\n    )\n\n    if (this.cachedInterceptionRewrites === interceptionRewrites) {\n      return\n    }\n    this.cachedInterceptionRewrites = interceptionRewrites\n\n    const interceptionRewriteManifestPath = join(\n      this.distDir,\n      'server',\n      `${INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`\n    )\n    deleteCache(interceptionRewriteManifestPath)\n\n    writeFileAtomic(\n      interceptionRewriteManifestPath,\n      `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n        interceptionRewrites\n      )};`\n    )\n  }\n\n  private writeBuildManifest(lowPriorityFiles: string[]): void {\n    if (!this.buildManifests.takeChanged()) {\n      return\n    }\n    const buildManifest = this.mergeBuildManifests(\n      this.buildManifests.values(),\n      lowPriorityFiles\n    )\n\n    const buildManifestPath = join(this.distDir, BUILD_MANIFEST)\n    const middlewareBuildManifestPath = join(\n      this.distDir,\n      'server',\n      `${MIDDLEWARE_BUILD_MANIFEST}.js`\n    )\n\n    deleteCache(buildManifestPath)\n    deleteCache(middlewareBuildManifestPath)\n    writeFileAtomic(buildManifestPath, JSON.stringify(buildManifest, null, 2))\n    writeFileAtomic(\n      middlewareBuildManifestPath,\n      createEdgeRuntimeManifest(buildManifest)\n    )\n\n    // Write fallback build manifest\n    const fallbackBuildManifest = this.mergeBuildManifests(\n      [\n        this.buildManifests.get(getEntryKey('pages', 'server', '_app')),\n        this.buildManifests.get(getEntryKey('pages', 'server', '_error')),\n      ].filter(Boolean) as BuildManifest[],\n      lowPriorityFiles\n    )\n    const fallbackBuildManifestPath = join(\n      this.distDir,\n      `fallback-${BUILD_MANIFEST}`\n    )\n    deleteCache(fallbackBuildManifestPath)\n    writeFileAtomic(\n      fallbackBuildManifestPath,\n      JSON.stringify(fallbackBuildManifest, null, 2)\n    )\n  }\n\n  private writeClientBuildManifest(\n    entrypoints: Entrypoints,\n    devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n    productionRewrites: CustomRoutes['rewrites'] | undefined\n  ): string[] {\n    const rewrites = normalizeRewritesForBuildManifest(\n      productionRewrites ?? {\n        ...devRewrites,\n        beforeFiles: (devRewrites?.beforeFiles ?? []).map(processRoute),\n        afterFiles: (devRewrites?.afterFiles ?? []).map(processRoute),\n        fallback: (devRewrites?.fallback ?? []).map(processRoute),\n      }\n    )\n\n    const pagesKeys = [...entrypoints.page.keys()]\n    if (entrypoints.global.app) {\n      pagesKeys.push('/_app')\n    }\n    if (entrypoints.global.error) {\n      pagesKeys.push('/_error')\n    }\n\n    const sortedPageKeys = getSortedRoutes(pagesKeys)\n\n    let buildManifestPath\n    let ssgManifestPath\n    if (this.deploymentId && !this.dev) {\n      // When skew protection is enabled, we instead just rely on the deployment id query string to\n      // load the correct manifests, to avoid the build id.\n      buildManifestPath = join(CLIENT_STATIC_FILES_PATH, '_buildManifest.js')\n      ssgManifestPath = join(CLIENT_STATIC_FILES_PATH, '_ssgManifest.js')\n    } else {\n      buildManifestPath = join(\n        CLIENT_STATIC_FILES_PATH,\n        this.buildId,\n        '_buildManifest.js'\n      )\n      ssgManifestPath = join(\n        CLIENT_STATIC_FILES_PATH,\n        this.buildId,\n        '_ssgManifest.js'\n      )\n    }\n\n    if (\n      this.dev &&\n      !this.clientBuildManifests.takeChanged({ rewrites, sortedPageKeys })\n    ) {\n      return [buildManifestPath, ssgManifestPath]\n    }\n\n    const clientBuildManifest = this.mergeClientBuildManifests(\n      this.clientBuildManifests.values(),\n      rewrites,\n      sortedPageKeys\n    )\n    const clientBuildManifestJs = `self.__BUILD_MANIFEST = ${JSON.stringify(\n      clientBuildManifest,\n      null,\n      2\n    )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n\n    writeFileAtomic(\n      join(this.distDir, buildManifestPath),\n      clientBuildManifestJs\n    )\n    // This is just an empty placeholder, the actual manifest is written after prerendering in\n    // packages/next/src/build/index.ts\n    writeFileAtomic(join(this.distDir, ssgManifestPath), srcEmptySsgManifest)\n\n    return [buildManifestPath, ssgManifestPath]\n  }\n\n  loadFontManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n    this.fontManifests.set(\n      getEntryKey(type, 'server', pageName),\n      readPartialManifestContent(\n        this.distDir,\n        `${NEXT_FONT_MANIFEST}.json`,\n        pageName,\n        type\n      )\n    )\n  }\n\n  private mergeFontManifests(manifests: Iterable<NextFontManifest>) {\n    const manifest: NextFontManifest = {\n      app: {},\n      appUsingSizeAdjust: false,\n      pages: {},\n      pagesUsingSizeAdjust: false,\n    }\n    for (const m of manifests) {\n      Object.assign(manifest.app, m.app)\n      Object.assign(manifest.pages, m.pages)\n\n      manifest.appUsingSizeAdjust =\n        manifest.appUsingSizeAdjust || m.appUsingSizeAdjust\n      manifest.pagesUsingSizeAdjust =\n        manifest.pagesUsingSizeAdjust || m.pagesUsingSizeAdjust\n    }\n    manifest.app = sortObjectByKey(manifest.app)\n    manifest.pages = sortObjectByKey(manifest.pages)\n    return manifest\n  }\n\n  private async writeNextFontManifest(): Promise<void> {\n    if (!this.fontManifests.takeChanged()) {\n      return\n    }\n    const fontManifest = this.mergeFontManifests(this.fontManifests.values())\n    const json = JSON.stringify(fontManifest, null, 2)\n\n    const fontManifestJsonPath = join(\n      this.distDir,\n      'server',\n      `${NEXT_FONT_MANIFEST}.json`\n    )\n    const fontManifestJsPath = join(\n      this.distDir,\n      'server',\n      `${NEXT_FONT_MANIFEST}.js`\n    )\n    deleteCache(fontManifestJsonPath)\n    deleteCache(fontManifestJsPath)\n    writeFileAtomic(fontManifestJsonPath, json)\n    writeFileAtomic(\n      fontManifestJsPath,\n      `self.__NEXT_FONT_MANIFEST=${JSON.stringify(json)}`\n    )\n  }\n\n  /**\n   * @returns If the manifest was written or not\n   */\n  loadMiddlewareManifest(\n    pageName: string,\n    type: 'pages' | 'app' | 'middleware' | 'instrumentation'\n  ): boolean {\n    const middlewareManifestPath = getManifestPath(\n      pageName,\n      this.distDir,\n      MIDDLEWARE_MANIFEST,\n      type,\n      true\n    )\n\n    // middlewareManifest is actually \"edge manifest\" and not all routes are edge runtime. If it is not written we skip it.\n    if (!existsSync(middlewareManifestPath)) {\n      return false\n    }\n\n    this.middlewareManifests.set(\n      getEntryKey(\n        type === 'middleware' || type === 'instrumentation' ? 'root' : type,\n        'server',\n        pageName\n      ),\n      readPartialManifestContent(\n        this.distDir,\n        MIDDLEWARE_MANIFEST,\n        pageName,\n        type\n      )\n    )\n\n    return true\n  }\n\n  getMiddlewareManifest(key: EntryKey) {\n    return this.middlewareManifests.get(key)\n  }\n\n  deleteMiddlewareManifest(key: EntryKey) {\n    return this.middlewareManifests.delete(key)\n  }\n\n  private mergeMiddlewareManifests(\n    manifests: Iterable<TurbopackMiddlewareManifest>\n  ): MiddlewareManifest {\n    const manifest: MiddlewareManifest = {\n      version: 3,\n      middleware: {},\n      sortedMiddleware: [],\n      functions: {},\n    }\n    let instrumentation: InstrumentationDefinition | undefined = undefined\n    for (const m of manifests) {\n      Object.assign(manifest.functions, m.functions)\n      Object.assign(manifest.middleware, m.middleware)\n      if (m.instrumentation) {\n        instrumentation = m.instrumentation\n      }\n    }\n    manifest.functions = sortObjectByKey(manifest.functions)\n    manifest.middleware = sortObjectByKey(manifest.middleware)\n    const updateFunctionDefinition = (\n      fun: EdgeFunctionDefinition\n    ): EdgeFunctionDefinition => {\n      return {\n        ...fun,\n        files: [...(instrumentation?.files ?? []), ...fun.files],\n      }\n    }\n    for (const key of Object.keys(manifest.middleware)) {\n      const value = manifest.middleware[key]\n      manifest.middleware[key] = updateFunctionDefinition(value)\n    }\n    for (const key of Object.keys(manifest.functions)) {\n      const value = manifest.functions[key]\n      manifest.functions[key] = updateFunctionDefinition(value)\n    }\n    for (const fun of Object.values(manifest.functions).concat(\n      Object.values(manifest.middleware)\n    )) {\n      for (const matcher of fun.matchers) {\n        if (!matcher.regexp) {\n          matcher.regexp = safePathToRegexp(matcher.originalSource, [], {\n            delimiter: '/',\n            sensitive: false,\n            strict: true,\n          }).source.replaceAll('\\\\/', '/')\n        }\n      }\n    }\n    manifest.sortedMiddleware = Object.keys(manifest.middleware)\n\n    return manifest\n  }\n\n  private writeMiddlewareManifest(): {\n    clientMiddlewareManifestPath: string\n  } {\n    let clientMiddlewareManifestPath =\n      this.deploymentId && !this.dev\n        ? join(CLIENT_STATIC_FILES_PATH, TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST)\n        : join(\n            CLIENT_STATIC_FILES_PATH,\n            this.buildId,\n            TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST\n          )\n\n    if (this.dev && !this.middlewareManifests.takeChanged()) {\n      return {\n        clientMiddlewareManifestPath,\n      }\n    }\n    const middlewareManifest = this.mergeMiddlewareManifests(\n      this.middlewareManifests.values()\n    )\n\n    // Server middleware manifest\n\n    // Normalize regexes as it uses path-to-regexp\n    for (const key in middlewareManifest.middleware) {\n      middlewareManifest.middleware[key].matchers.forEach((matcher) => {\n        if (!matcher.regexp.startsWith('^')) {\n          const parsedPage = tryToParsePath(matcher.regexp)\n          if (parsedPage.error || !parsedPage.regexStr) {\n            throw new Error(`Invalid source: ${matcher.regexp}`)\n          }\n          matcher.regexp = parsedPage.regexStr\n        }\n      })\n    }\n\n    const middlewareManifestPath = join(\n      this.distDir,\n      'server',\n      MIDDLEWARE_MANIFEST\n    )\n    deleteCache(middlewareManifestPath)\n    writeFileAtomic(\n      middlewareManifestPath,\n      JSON.stringify(middlewareManifest, null, 2)\n    )\n\n    // Client middleware manifest This is only used in dev though, packages/next/src/build/index.ts\n    // writes the mainfest again for builds.\n    const matchers = middlewareManifest?.middleware['/']?.matchers || []\n\n    const clientMiddlewareManifestJs = `self.__MIDDLEWARE_MATCHERS = ${JSON.stringify(\n      matchers,\n      null,\n      2\n    )};self.__MIDDLEWARE_MATCHERS_CB && self.__MIDDLEWARE_MATCHERS_CB()`\n\n    deleteCache(clientMiddlewareManifestPath)\n    writeFileAtomic(\n      join(this.distDir, clientMiddlewareManifestPath),\n      clientMiddlewareManifestJs\n    )\n\n    return {\n      clientMiddlewareManifestPath,\n    }\n  }\n\n  loadPagesManifest(pageName: string): void {\n    this.pagesManifests.set(\n      getEntryKey('pages', 'server', pageName),\n      readPartialManifestContent(this.distDir, PAGES_MANIFEST, pageName)\n    )\n  }\n\n  private mergePagesManifests(manifests: Iterable<PagesManifest>) {\n    const manifest: PagesManifest = {}\n    for (const m of manifests) {\n      Object.assign(manifest, m)\n    }\n    return sortObjectByKey(manifest)\n  }\n\n  private writePagesManifest(): void {\n    if (!this.pagesManifests.takeChanged()) {\n      return\n    }\n    const pagesManifest = this.mergePagesManifests(this.pagesManifests.values())\n    const pagesManifestPath = join(this.distDir, 'server', PAGES_MANIFEST)\n    deleteCache(pagesManifestPath)\n    writeFileAtomic(pagesManifestPath, JSON.stringify(pagesManifest, null, 2))\n  }\n\n  writeManifests({\n    devRewrites,\n    productionRewrites,\n    entrypoints,\n  }: {\n    devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined\n    productionRewrites: CustomRoutes['rewrites'] | undefined\n    entrypoints: Entrypoints\n  }): void {\n    this.writeActionManifest()\n    this.writeAppPathsManifest()\n    const lowPriorityFiles = this.writeClientBuildManifest(\n      entrypoints,\n      devRewrites,\n      productionRewrites\n    )\n    const { clientMiddlewareManifestPath } = this.writeMiddlewareManifest()\n    this.writeBuildManifest([...lowPriorityFiles, clientMiddlewareManifestPath])\n    this.writeInterceptionRouteRewriteManifest(devRewrites, productionRewrites)\n    this.writeNextFontManifest()\n    this.writePagesManifest()\n\n    if (process.env.TURBOPACK_STATS != null) {\n      this.writeWebpackStats()\n    }\n  }\n}\n\nfunction sortObjectByKey(obj: Record<string, any>) {\n  return Object.keys(obj)\n    .sort()\n    .reduce(\n      (acc, key) => {\n        acc[key] = obj[key]\n        return acc\n      },\n      {} as Record<string, any>\n    )\n}\n"],"names":["TurbopackManifestLoader","getManifestPath","page","distDir","name","type","firstCall","manifestPath","posix","join","getAssetPathFromRoute","isSitemapRoute","test","existsSync","replace","endsWith","metadataPage","addRouteSuffix","addMetadataIdToRoute","removeRouteSuffix","readPartialManifestContent","pageName","readFileSync","ManifestsMap","set","key","value","rawMap","get","changed","map","JSON","parse","delete","has","takeChanged","extraInvalidationKey","undefined","stringified","stringify","values","Map","constructor","buildId","encryptionKey","dev","deploymentId","actionManifests","appPathsManifests","buildManifests","clientBuildManifests","fontManifests","middlewareManifests","pagesManifests","webpackStats","cachedInterceptionRewrites","loadActionManifest","getEntryKey","SERVER_REFERENCE_MANIFEST","mergeActionManifests","manifests","manifest","node","edge","mergeActionIds","actionEntries","other","action","workers","layer","filename","exportedName","Object","assign","m","entry","sortObjectByKey","writeActionManifest","actionManifest","actionManifestJsonPath","actionManifestJsPath","json","deleteCache","writeFileAtomic","loadAppPathsManifest","APP_PATHS_MANIFEST","writeAppPathsManifest","appPathsManifest","mergePagesManifests","appPathsManifestPath","writeWebpackStats","mergeWebpackStats","path","WEBPACK_STATS","loadBuildManifest","BUILD_MANIFEST","loadClientBuildManifest","TURBOPACK_CLIENT_BUILD_MANIFEST","loadWebpackStats","statsFiles","entrypoints","assets","chunks","modules","statsFile","k","v","entries","asset","chunk","id","module","existing","includes","push","version","mergeBuildManifests","lowPriorityFiles","pages","devFiles","polyfillFiles","rootMainFiles","length","mergeClientBuildManifests","rewrites","sortedPageKeys","__rewrites","sortedPages","writeInterceptionRouteRewriteManifest","devRewrites","productionRewrites","beforeFiles","processRoute","afterFiles","fallback","interceptionRewrites","filter","isInterceptionRouteRewrite","interceptionRewriteManifestPath","INTERCEPTION_ROUTE_REWRITE_MANIFEST","writeBuildManifest","buildManifest","buildManifestPath","middlewareBuildManifestPath","MIDDLEWARE_BUILD_MANIFEST","createEdgeRuntimeManifest","fallbackBuildManifest","Boolean","fallbackBuildManifestPath","writeClientBuildManifest","normalizeRewritesForBuildManifest","pagesKeys","keys","global","app","error","getSortedRoutes","ssgManifestPath","CLIENT_STATIC_FILES_PATH","clientBuildManifest","clientBuildManifestJs","srcEmptySsgManifest","loadFontManifest","NEXT_FONT_MANIFEST","mergeFontManifests","appUsingSizeAdjust","pagesUsingSizeAdjust","writeNextFontManifest","fontManifest","fontManifestJsonPath","fontManifestJsPath","loadMiddlewareManifest","middlewareManifestPath","MIDDLEWARE_MANIFEST","getMiddlewareManifest","deleteMiddlewareManifest","mergeMiddlewareManifests","middleware","sortedMiddleware","functions","instrumentation","updateFunctionDefinition","fun","files","concat","matcher","matchers","regexp","safePathToRegexp","originalSource","delimiter","sensitive","strict","source","replaceAll","writeMiddlewareManifest","clientMiddlewareManifestPath","TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST","middlewareManifest","forEach","startsWith","parsedPage","tryToParsePath","regexStr","Error","clientMiddlewareManifestJs","loadPagesManifest","PAGES_MANIFEST","writePagesManifest","pagesManifest","pagesManifestPath","writeManifests","process","env","TURBOPACK_STATS","obj","sort","reduce","acc"],"mappings":"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","ignoreList":[0]}